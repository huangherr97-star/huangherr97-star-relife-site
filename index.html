<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RE:LIFE | 回环</title>

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" />

    <!-- Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            color: #222;
            transition: background 0.3s, color 0.3s;
        }
        body.dark {
            background: #1e1e1e;
            color: #ddd;
        }
        header {
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
        }
        textarea, input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 15px;
        }
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            margin-right: 10px;
        }
        button.primary {
            background: #0078ff;
            color: white;
        }
        button.secondary {
            background: #ddd;
        }
        button.dark {
            background: #444;
            color: white;
        }
        .output-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        body.dark .output-card {
            background: #2a2a2a;
        }
        .loading {
            display: none;
            margin-top: 10px;
            font-style: italic;
        }
        .route-buttons {
            margin-top: 10px;
        }
        .route-buttons button {
            margin-right: 8px;
        }
    </style>

    <!-- jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
<header>RE:LIFE | 回环</header>

<div class="container">

    <!-- Language Switch -->
    <div class="section">
        <label id="label-language">选择语言 / Choose Language</label>
        <select id="language">
            <option value="zh">中文</option>
            <option value="en">English</option>
        </select>
    </div>

    <!-- User Inputs -->
    <div class="section">
        <label id="label-background">你的背景 / Your Background</label>
        <textarea id="background" rows="3"></textarea>

        <label id="label-timeline">人生时间线 / Life Timeline</label>
        <textarea id="timeline" rows="3"></textarea>

        <label id="label-target">目标点 / Target Point</label>
        <textarea id="target" rows="3"></textarea>

        <label id="label-mode">模式 / Mode</label>
        <select id="mode">
            <option value="abc">A/B/C 路线对比</option>
            <option value="single">单路线</option>
            <option value="chat">连续对话模式</option>
        </select>

        <label id="label-skills">技能与资源 / Skills & Resources</label>
        <textarea id="skills" rows="3"></textarea>
    </div>

    <!-- Buttons -->
    <div class="section">
        <button class="primary" id="start">开始模拟 / Start</button>
        <button class="secondary" id="clear">清空输出 / Clear</button>
        <button class="secondary" id="theme">切换主题 / Theme</button>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading">生成中，请稍候...</div>

    <!-- Output -->
    <div id="output" class="output-card" style="display:none;"></div>

    <!-- Route Buttons -->
    <div id="routeButtons" class="route-buttons" style="display:none;">
        <button id="openA">打开路线 A</button>
        <button id="openB">打开路线 B</button>
        <button id="openC">打开路线 C</button>
        <button id="copyResult">复制结果</button>
        <button id="exportPDF">导出 PDF</button>
    </div>

</div>

<!-- Main Script -->
<script>
/* -------------------------------
   Language System
-------------------------------- */
const lang = {
    zh: {
        background: "你的背景",
        timeline: "人生时间线",
        target: "目标点",
        mode: "模式",
        skills: "技能与资源",
        generating: "生成中，请稍候...",
        start: "开始模拟",
        clear: "清空输出",
        theme: "切换主题",
        chooseLang: "选择语言"
    },
    en: {
        background: "Your Background",
        timeline: "Life Timeline",
        target: "Target Point",
        mode: "Mode",
        skills: "Skills & Resources",
        generating: "Generating...",
        start: "Start Simulation",
        clear: "Clear Output",
        theme: "Toggle Theme",
        chooseLang: "Choose Language"
    }
};

function applyLanguage() {
    const l = document.getElementById("language").value;
    document.getElementById("label-language").innerText = lang[l].chooseLang;
    document.getElementById("label-background").innerText = lang[l].background;
    document.getElementById("label-timeline").innerText = lang[l].timeline;
    document.getElementById("label-target").innerText = lang[l].target;
    document.getElementById("label-mode").innerText = lang[l].mode;
    document.getElementById("label-skills").innerText = lang[l].skills;
    document.getElementById("loading").innerText = lang[l].generating;
}
document.getElementById("language").addEventListener("change", () => {
    localStorage.setItem("lang", document.getElementById("language").value);
    applyLanguage();
});

/* -------------------------------
   Theme Switch
-------------------------------- */
document.getElementById("theme").addEventListener("click", () => {
    document.body.classList.toggle("dark");
});

/* -------------------------------
   Start Simulation
-------------------------------- */
document.getElementById("start").addEventListener("click", async () => {
    const background = document.getElementById("background").value;
    const timeline = document.getElementById("timeline").value;
    const target = document.getElementById("target").value;
    const mode = document.getElementById("mode").value;
    const skills = document.getElementById("skills").value;
    const langPref = document.getElementById("language").value;

    const loading = document.getElementById("loading");
    const output = document.getElementById("output");
    const routeButtons = document.getElementById("routeButtons");

    loading.style.display = "block";
    output.style.display = "none";
    routeButtons.style.display = "none";

    try {
        const res = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                background,
                timeline,
                target,
                mode,
                skills,
                lang: langPref
            })
        });

        const data = await res.json();
        output.innerText = data.result;
        output.style.display = "block";
        routeButtons.style.display = "block";

    } catch (err) {
        output.innerText = "❌ 发生错误：" + err.message;
        output.style.display = "block";
    }

    loading.style.display = "none";
});

/* -------------------------------
   Clear Output
-------------------------------- */
document.getElementById("clear").addEventListener("click", () => {
    document.getElementById("output").style.display = "none";
    document.getElementById("routeButtons").style.display = "none";
});

/* -------------------------------
   Copy Result
-------------------------------- */
document.getElementById("copyResult").addEventListener("click", () => {
    const text = document.getElementById("output").innerText;
    navigator.clipboard.writeText(text);
});

/* -------------------------------
   Export PDF
-------------------------------- */
document.getElementById("exportPDF").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "pt", format: "a4" });
    const text = document.getElementById("output").innerText;

    const lines = pdf.splitTextToSize(text, 500);
    pdf.text(lines, 50, 50);
    pdf.save("relife_result.pdf");
});

/* -------------------------------
   Open Routes in New Window
-------------------------------- */
function openRoute(letter) {
    const text = document.getElementById("output").innerText;
    const win = window.open("", "_blank");
    win.document.write("<pre style='font-family:Arial; white-space:pre-wrap;'>" + text + "</pre>");
}

document.getElementById("openA").addEventListener("click", () => openRoute("A"));
document.getElementById("openB").addEventListener("click", () => openRoute("B"));
document.getElementById("openC").addEventListener("click", () => openRoute("C"));

/* -------------------------------
   Load Language Preference
-------------------------------- */
window.onload = () => {
    const saved = localStorage.getItem("lang");
    if (saved) {
        document.getElementById("language").value = saved;
    }
    applyLanguage();
};
</script>

</body>
</html>
