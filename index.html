<!doctype html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RE:LIFE | 回环</title>

  <!-- jsPDF 用于导出 PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0B1220;--card:#0f1a33cc;--line:#22304f;--text:#e8eefc;--muted:#9fb0d5;
      --primary:#4C6FFF;--primary2:#22D3EE;--warn:#F59E0B;
      --card-soft:rgba(255,255,255,.06);
    }
    :root[data-theme="light"]{
      --bg:#f3f4f6;--card:#ffffff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
      --primary:#2563eb;--primary2:#0ea5e9;--warn:#d97706;
      --card-soft:rgba(15,23,42,.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .title{display:flex;align-items:flex-end;gap:12px;margin-bottom:22px}
    .title h1{font-size:42px;letter-spacing:.5px;margin:0}
    .title .sub{color:var(--muted);font-size:14px;margin-bottom:6px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, var(--card-soft), var(--card-soft));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
      overflow:hidden;
    }
    :root[data-theme="light"] .card{
      border:1px solid #e5e7eb;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .card .hd{padding:18px 18px 10px;border-bottom:1px solid rgba(255,255,255,.07)}
    :root[data-theme="light"] .card .hd{border-bottom:1px solid #e5e7eb;}
    .card .hd h2{margin:0;font-size:18px}
    .card .bd{padding:18px}
    label{display:block;color:var(--muted);font-size:13px;margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      background:rgba(10,16,28,.55);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
    }
    :root[data-theme="light"] input,
    :root[data-theme="light"] textarea,
    :root[data-theme="light"] select{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      border:0;cursor:pointer;border-radius:12px;
      padding:10px 14px;font-weight:600;color:#081022;
      background:linear-gradient(135deg,var(--primary), #5a7bff);
      font-size:14px;
    }
    button.secondary{
      color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }
    :root[data-theme="light"] button.secondary{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    button.danger{
      color:#fff;background:rgba(245, 89, 11, .18);
      border:1px solid rgba(245, 89, 11, .35);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--muted);font-size:12px
    }
    :root[data-theme="light"] .pill{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .status{margin-top:12px;color:var(--muted);font-size:13px}
    .out{
      white-space:pre-wrap;
      background:rgba(10,16,28,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px;
      min-height:220px;
      line-height:1.55;
    }
    :root[data-theme="light"] .out{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .foot{margin-top:18px;color:var(--muted);font-size:12px}

    .progress-wrap{
      margin-top:10px;
      height:6px;
      background:rgba(255,255,255,.06);
      border-radius:999px;
      overflow:hidden;
    }
    :root[data-theme="light"] .progress-wrap{
      background:#e5e7eb;
    }
    .progress-bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--primary),var(--primary2));
      transition:width .3s ease;
    }

    .theme-toggle{
      margin-left:10px;
      font-size:12px;
      padding:6px 10px;
    }

    .hint-short{
      margin-top:8px;
      font-size:12px;
      color:var(--warn);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>RE:LIFE | 回环</h1>
      <div class="sub">理性人生模拟 · 非算命 · 非保证</div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <div class="pill">
          API: <span id="apiLabel" class="mono"></span>
        </div>
        <button class="secondary theme-toggle" id="btnTheme">切换主题</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd"><h2>你的信息</h2></div>
        <div class="bd">
          <label>个人背景（必填） / Background</label>
          <input id="background" placeholder="例：28岁，工作3年，想转行/想创业…" />

          <label>人生经历时间线（必填） / Timeline</label>
          <textarea id="timeline" placeholder="用要点写：学校/工作/关键事件/决策/资源/人脉…"></textarea>

          <div class="row">
            <div>
              <label>想回到的时间点（必填） / Target Point</label>
              <input id="target" placeholder="例：18岁高考 / 22岁毕业 / 2020年某次决定" />
            </div>
            <div>
              <label>生成模式 / Mode</label>
              <select id="mode">
                <option value="abc" selected>对比 A/B/C（推荐）</option>
                <option value="single">单一路线（更快）</option>
                <option value="chat">追问模式（对话）</option>
              </select>
            </div>
          </div>

          <label>能力 / 资源（可选） / Resources</label>
          <input id="resources" placeholder="例：英语一般/有存款2万/家人支持/擅长写作…" />

          <label>语言 / Language</label>
          <select id="language">
            <option value="zh" selected>中文</option>
            <option value="en">English</option>
          </select>

          <div class="btns">
            <button id="btnRun">开始模拟 / Run</button>
            <button class="secondary" id="btnPing">测试 API</button>
            <button class="secondary" id="btnCopy">复制结果</button>
            <button class="secondary" id="btnPDF">导出 PDF</button>
            <button class="secondary" id="btnShare">分享链接</button>
            <button class="danger" id="btnClear">清空输出</button>
          </div>

          <div class="progress-wrap">
            <div class="progress-bar" id="progressBar"></div>
          </div>

          <div class="status" id="status">状态：就绪</div>
          <div class="hint-short" id="hintShort" style="display:none;">
            建议补充信息（追问）：可以多写一些关键节点、转折点、你在意的东西。
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>结果 / Result</h2></div>
        <div class="bd">
          <div id="out" class="out">点击“开始模拟”生成内容。</div>
          <div class="foot">
            如果长时间无响应，可以先点“测试 API”确认 /api/ping 是否正常，再检查 OpenAI 配额。
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const { jsPDF } = window.jspdf;

  const API_BASE = (location.hostname === "resetlife.blog")
    ? "https://www.resetlife.blog"
    : "";

  document.getElementById("apiLabel").textContent = API_BASE ? (API_BASE + "/api") : "/api";

  const $ = (id)=>document.getElementById(id);
  const outEl = $("out");
  const statusEl = $("status");
  const progressBar = $("progressBar");
  const hintShortEl = $("hintShort");

  function setStatus(s){ statusEl.textContent = "状态：" + s; }

  function setProgress(p){
    progressBar.style.width = Math.max(0, Math.min(100, p)) + "%";
  }

  function formatError(e){
    return [
      "❌ 请求失败",
      "",
      "错误信息：",
      String(e),
      "",
      "可能原因：",
      "- API 未命中 Vercel（先点“测试 API”）",
      "- 输入字段缺失或过短",
      "- OpenAI 请求超时或限流",
      "- 网络问题",
      "",
      "建议：",
      "- 刷新页面重试",
      "- 检查 /api/ping 是否正常",
      "- 检查 OpenAI 账单与配额",
    ].join("\n");
  }

  async function postJSON(path, body, timeoutMs=90000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body),
        signal: ctrl.signal,
      });

      const ct = res.headers.get("content-type") || "";
      const text = await res.text();

      if (!ct.includes("application/json")) {
        const hint = [
          `HTTP ${res.status} ${res.statusText}`,
          `content-type: ${ct || "(none)"}`,
          `server: ${res.headers.get("server") || "(none)"}`,
          `x-vercel-id: ${res.headers.get("x-vercel-id") || "(none)"}`,
          "",
          text
        ].join("\n");
        throw new Error(hint);
      }

      const data = JSON.parse(text);
      if(!res.ok){
        throw new Error(`HTTP ${res.status}: ${JSON.stringify(data)}`);
      }
      return data;
    } finally {
      clearTimeout(t);
    }
  }

  async function getText(path, timeoutMs=15000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(path, { signal: ctrl.signal });
      const text = await res.text();
      return { res, text };
    } finally { clearTimeout(t); }
  }

  // 主题切换
  $("btnTheme").onclick = ()=>{
    const root = document.documentElement;
    const cur = root.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    root.setAttribute("data-theme", next);
    localStorage.setItem("relife-theme", next);
  };
  (function initTheme(){
    const saved = localStorage.getItem("relife-theme");
    if (saved) document.documentElement.setAttribute("data-theme", saved);
  })();

  // 清空
  $("btnClear").onclick = ()=>{ outEl.textContent = ""; setStatus("已清空"); setProgress(0); hintShortEl.style.display = "none"; };

  // ping
  $("btnPing").onclick = async ()=>{
    setStatus("ping 中…");
    setProgress(20);
    try{
      const { res, text } = await getText(API_BASE + "/api/ping");
      outEl.textContent =
        `GET ${API_BASE}/api/ping\n` +
        `HTTP ${res.status}\n` +
        `server: ${res.headers.get("server") || "(none)"}\n` +
        `x-vercel-id: ${res.headers.get("x-vercel-id") || "(none)"}\n\n` +
        text;
      setStatus("ping 完成");
      setProgress(100);
      setTimeout(()=>setProgress(0), 800);
    }catch(e){
      outEl.textContent = formatError(e);
      setStatus("ping 失败");
      setProgress(0);
    }
  };

  // 复制结果
  $("btnCopy").onclick = async ()=>{
    const text = outEl.textContent.trim();
    if (!text) {
      alert("没有可复制的内容，请先生成结果。");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      setStatus("结果已复制到剪贴板");
    }catch(e){
      alert("复制失败：" + e);
    }
  };

  // 导出 PDF
  $("btnPDF").onclick = ()=>{
    const content = outEl.textContent.trim();
    if (!content) {
      alert("没有可导出的内容，请先生成结果。");
      return;
    }

    const doc = new jsPDF({ unit: "pt", format: "a4" });
    const margin = 40;
    let y = 60;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("RE:LIFE 模拟结果分享", margin, y);
    y += 24;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(120);
    doc.text("生成时间：" + new Date().toLocaleString(), margin, y);
    y += 20;

    doc.setDrawColor(200);
    doc.line(margin, y, 595 - margin, y);
    y += 20;

    doc.setFontSize(12);
    doc.setTextColor(0);

    const inputBlock = [
      "【用户输入】",
      "背景：" + ($("background").value || "（未填写）"),
      "时间线：" + ($("timeline").value || "（未填写）"),
      "回到时间点：" + ($("target").value || "（未填写）"),
      "能力/资源：" + ($("resources").value || "（未填写）"),
      "模式：" + ($("mode").value || "（未选择）"),
      "语言：" + ($("language").value || "zh"),
      "",
      "【模拟结果】",
      content
    ].join("\n");

    const lines = doc.splitTextToSize(inputBlock, 595 - margin * 2);
    const pageHeight = doc.internal.pageSize.getHeight();
    for (let i = 0; i < lines.length; i++) {
      if (y > pageHeight - 60) {
        doc.addPage();
        y = 60;
      }
      doc.text(lines[i], margin, y);
      y += 16;
    }

    doc.save("RE_LIFE_模拟结果.pdf");
    setStatus("PDF 已导出");
  };

  // 分享链接
  $("btnShare").onclick = ()=>{
    const params = new URLSearchParams({
      background: $("background").value,
      timeline: $("timeline").value,
      target: $("target").value,
      resources: $("resources").value,
      mode: $("mode").value,
      language: $("language").value,
    });
    const url = location.origin + location.pathname + "?" + params.toString();
    navigator.clipboard.writeText(url).then(()=>{
      setStatus("分享链接已复制");
      alert("分享链接已复制：\n" + url);
    }).catch(e=>{
      alert("复制失败：" + e);
    });
  };

  // URL 参数自动填充
  (function fillFromQuery(){
    const p = new URLSearchParams(location.search);
    if (p.get("background")) $("background").value = p.get("background");
    if (p.get("timeline")) $("timeline").value = p.get("timeline");
    if (p.get("target")) $("target").value = p.get("target");
    if (p.get("resources")) $("resources").value = p.get("resources");
    if (p.get("mode")) $("mode").value = p.get("mode");
    if (p.get("language")) $("language").value = p.get("language");
  })();

  // 打开新窗口展示 A/B/C + 对话
  function openResultWindow({ text, routes, followups, plan30d, context }) {
    const w = window.open("", "_blank");
    if (!w) {
      alert("浏览器拦截了新窗口，请允许弹出窗口。");
      return;
    }

    const lang = context.language === "en" ? "en" : "zh";

    const title = lang === "en" ? "RE:LIFE Result" : "RE:LIFE 模拟结果";
    const labelRoutes = lang === "en" ? "Routes" : "路线 A/B/C";
    const labelChat = lang === "en" ? "Follow-up Chat" : "追问对话";
    const labelScores = lang === "en" ? "Scores" : "评分维度";
    const labelPlan = lang === "en" ? "30-Day Plan" : "30 天行动计划";
    const labelAsk = lang === "en" ? "Ask" : "提问";
    const labelPlaceholderQ = lang === "en"
      ? "e.g. Am I more suitable for route B?"
      : "例如：我更适合 B 吗？最小风险路线是什么？";
    const labelFollowups = lang === "en" ? "Suggested follow-up questions" : "建议追问";
    const labelContext = lang === "en" ? "Context" : "上下文摘要";

    const html = `
<!doctype html>
<html lang="${lang}">
<head>
<meta charset="utf-8" />
<title>${title}</title>
<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    background:#0b1120;
    color:#e5e7eb;
  }
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px;}
  h1{font-size:28px;margin:0 0 12px;}
  h2{font-size:18px;margin:18px 0 8px;}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;}
  @media (max-width:900px){.grid{grid-template-columns:1fr;}}
  .card{
    background:rgba(15,23,42,.9);
    border-radius:16px;
    border:1px solid rgba(148,163,184,.4);
    padding:16px;
  }
  .routes{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
  .route-pill{
    flex:1 1 0;
    min-width:120px;
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,.6);
    cursor:pointer;
    background:rgba(15,23,42,.8);
  }
  .route-pill.active{
    border-color:#4f46e5;
    box-shadow:0 0 0 1px rgba(79,70,229,.6);
  }
  .route-pill h3{margin:0 0 4px;font-size:14px;}
  .route-pill p{margin:0;font-size:12px;color:#9ca3af;}
  .scores-table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
    font-size:12px;
  }
  .scores-table th,.scores-table td{
    border:1px solid rgba(148,163,184,.5);
    padding:4px 6px;
    text-align:center;
  }
  .text-block{
    white-space:pre-wrap;
    font-size:13px;
    line-height:1.6;
    background:rgba(15,23,42,.8);
    border-radius:10px;
    padding:10px;
    border:1px solid rgba(148,163,184,.4);
  }
  .chat-box{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .chat-log{
    height:260px;
    overflow:auto;
    background:rgba(15,23,42,.8);
    border-radius:10px;
    padding:10px;
    border:1px solid rgba(148,163,184,.4);
    font-size:13px;
  }
  .chat-msg-user{color:#e5e7eb;margin-bottom:6px;}
  .chat-msg-ai{color:#a5b4fc;margin-bottom:10px;}
  .chat-input-row{
    display:flex;
    gap:8px;
    margin-top:4px;
  }
  .chat-input-row input{
    flex:1;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    outline:none;
  }
  .chat-input-row button{
    padding:8px 14px;
    border-radius:999px;
    border:0;
    background:linear-gradient(135deg,#4f46e5,#6366f1);
    color:#0b1120;
    font-weight:600;
    cursor:pointer;
  }
  .followups{
    font-size:12px;
    color:#9ca3af;
    margin-top:6px;
  }
  .followups span{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    margin:2px;
    cursor:pointer;
  }
  .plan-list{
    font-size:13px;
    margin-top:6px;
  }
  .plan-list li{margin-bottom:4px;}
  .ctx{
    font-size:11px;
    color:#9ca3af;
    margin-top:6px;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>${title}</h1>
  <div class="grid">
    <div class="card">
      <h2>${labelRoutes}</h2>
      <div class="routes" id="routes"></div>
      <h2>${labelScores}</h2>
      <table class="scores-table" id="scoresTable">
        <thead>
          <tr>
            <th>Route</th>
            <th>Risk</th>
            <th>Reward</th>
            <th>Time</th>
            <th>Mental</th>
          </tr>
        </thead>
        <tbody id="scoresBody"></tbody>
      </table>
      <h2>${labelPlan}</h2>
      <ul class="plan-list" id="planList"></ul>
      <div class="ctx">
        <strong>${labelContext}:</strong><br/>
        ${context.background}<br/>
        ${context.timeline}<br/>
        ${context.target ? "Target: " + context.target : ""}
      </div>
    </div>
    <div class="card">
      <h2>${labelChat}</h2>
      <div class="chat-box">
        <div class="chat-log" id="chatLog"></div>
        <div class="followups" id="followupsBox"></div>
        <div class="chat-input-row">
          <input id="chatInput" placeholder="${labelPlaceholderQ}" />
          <button id="chatSend">${labelAsk}</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  const routes = ${JSON.stringify(routes || [])};
  const followups = ${JSON.stringify(followups || [])};
  const plan30d = ${JSON.stringify(plan30d || [])};
  const baseText = ${JSON.stringify(text || "")};
  const ctx = ${JSON.stringify(context)};

  const routesEl = document.getElementById("routes");
  const scoresBody = document.getElementById("scoresBody");
  const planList = document.getElementById("planList");
  const chatLog = document.getElementById("chatLog");
  const followupsBox = document.getElementById("followupsBox");
  const chatInput = document.getElementById("chatInput");
  const chatSend = document.getElementById("chatSend");

  function renderRoutes() {
    routesEl.innerHTML = "";
    scoresBody.innerHTML = "";
    routes.forEach((r, idx)=>{
      const div = document.createElement("div");
      div.className = "route-pill" + (idx === 0 ? " active" : "");
      div.dataset.id = r.id || ("R" + (idx+1));
      div.innerHTML = "<h3>" + (r.id || ("R" + (idx+1))) + " · " + (r.title || "") + "</h3>" +
                      "<p>" + (r.summary || "") + "</p>";
      div.onclick = ()=>{
        document.querySelectorAll(".route-pill").forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
        appendAI("[" + (r.id || ("R" + (idx+1))) + "] " + (r.summary || ""));
      };
      routesEl.appendChild(div);

      const s = r.score || {};
      const tr = document.createElement("tr");
      tr.innerHTML =
        "<td>" + (r.id || ("R" + (idx+1))) + "</td>" +
        "<td>" + (s.risk ?? "-") + "</td>" +
        "<td>" + (s.reward ?? "-") + "</td>" +
        "<td>" + (s.timeCost ?? "-") + "</td>" +
        "<td>" + (s.mentalCost ?? "-") + "</td>";
      scoresBody.appendChild(tr);
    });
  }

  function renderPlan() {
    planList.innerHTML = "";
    (plan30d || []).forEach((p)=>{
      const li = document.createElement("li");
      li.textContent = p;
      planList.appendChild(li);
    });
  }

  function renderFollowups() {
    followupsBox.innerHTML = "";
    if (!followups || !followups.length) return;
    const label = document.createElement("div");
    label.textContent = "${labelFollowups}：";
    followupsBox.appendChild(label);
    followups.forEach(q=>{
      const span = document.createElement("span");
      span.textContent = q;
      span.onclick = ()=>{
        chatInput.value = q;
        chatInput.focus();
      };
      followupsBox.appendChild(span);
    });
  }

  function appendUser(msg) {
    const div = document.createElement("div");
    div.className = "chat-msg-user";
    div.textContent = "You: " + msg;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function appendAI(msg) {
    const div = document.createElement("div");
    div.className = "chat-msg-ai";
    div.textContent = msg;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  appendAI(baseText || "No result text.");

  renderRoutes();
  renderPlan();
  renderFollowups();

  async function sendChat() {
    const q = chatInput.value.trim();
    if (!q) return;
    chatInput.value = "";
    appendUser(q);
    appendAI("Thinking...");

    try{
      const res = await fetch("${API_BASE}/api/generate", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          background: ctx.background,
          timeline: ctx.timeline,
          target: ctx.target,
          resources: ctx.resources,
          mode: "chat",
          language: ctx.language,
          question: q,
          lastResult: baseText
        })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        appendAI("Error: " + (data.error || res.status));
        return;
      }
      appendAI(data.text || "");
    }catch(e){
      appendAI("Error: " + e);
    }
  }

  chatSend.onclick = sendChat;
  chatInput.addEventListener("keydown", (e)=>{
    if (e.key === "Enter") {
      e.preventDefault();
      sendChat();
    }
  });
</script>
</body>
</html>
`;

    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // 开始模拟
  $("btnRun").onclick = async ()=>{
    const background = $("background").value.trim();
    const timeline = $("timeline").value.trim();
    const target = $("target").value.trim();
    const resources = $("resources").value.trim();
    const mode = $("mode").value;
    const language = $("language").value;

    const totalLen = background.length + timeline.length;
    if (totalLen < 60) {
      hintShortEl.style.display = "block";
    } else {
      hintShortEl.style.display = "none";
    }

    if(!background || !timeline || !target){
      outEl.textContent = "请把：个人背景 / 时间线 / 想回到的时间点 填完整（必填）。";
      setStatus("缺少必填项");
      setProgress(0);
      return;
    }

    setStatus("请求中…");
    setProgress(10);
    outEl.textContent = "⏳ 正在生成…（通常 10~30 秒，如长时间无响应可先测试 API）";

    try{
      let fake = 10;
      const timer = setInterval(()=>{
        fake = Math.min(fake + 5, 85);
        setProgress(fake);
      }, 800);

      const data = await postJSON(API_BASE + "/api/generate", {
        background, timeline, target, resources, mode, language
      }, 120000);

      clearInterval(timer);
      setProgress(100);

      if (!data.ok) {
        outEl.textContent = JSON.stringify(data, null, 2);
        setStatus("后端返回错误");
        setTimeout(()=>setProgress(0), 1000);
        return;
      }

      const text = data.text || JSON.stringify(data, null, 2);
      outEl.textContent = text;
      setStatus("完成");
      setTimeout(()=>setProgress(0), 1000);

      // 打开新窗口展示 A/B/C + 对话
      openResultWindow({
        text: data.text,
        routes: data.routes,
        followups: data.followups,
        plan30d: data.plan30d,
        context: { background, timeline, target, resources, language }
      });
    }catch(e){
      outEl.textContent = formatError(e);
      setStatus("失败（看输出细节）");
      setProgress(0);
    }
  };
</script>
</body>
</html>
