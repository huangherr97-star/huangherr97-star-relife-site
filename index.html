<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RE:LIFE | 回环</title>
  <style>
    :root{--bg:#0B1220;--card:#0E1628;--border:#1C2433;--text:#E6EAF2;--muted:#A7B0C0;--primary:#4C6FFF;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,'Segoe UI','Noto Sans SC',sans-serif;line-height:1.6}
    main{max-width:920px;margin:0 auto;padding:28px 16px 60px}
    h1{margin:0 0 6px}
    .subtitle{color:var(--muted);font-size:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px 0}
    label{display:block;margin-top:12px;font-size:14px;color:var(--muted)}
    input,textarea{width:100%;margin-top:6px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0B1220;color:var(--text);resize:vertical}
    button{margin-top:16px;width:100%;padding:12px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-size:15px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{font-size:13px;color:var(--muted)}
    .status strong{color:var(--text)}
    .error{color:#ffb4b4}
    .ok{color:#b7f7d2}
    .branch{border-left:4px solid var(--primary);padding-left:12px;margin:14px 0}
    .branch h3{margin:4px 0 8px}
    .kv{margin:4px 0}
    .small{color:var(--muted);font-size:13px}
    footer{margin-top:40px;padding-top:16px;border-top:1px solid var(--border);color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<main>
  <h1>RE:LIFE｜回环</h1>
  <div class="subtitle">理性人生模拟 · 非算命 · 非保证</div>

  <div class="card">
    <h3>你的信息</h3>

    <label>个人背景</label>
    <input id="persona" placeholder="例如：28岁，普通本科，二线城市">

    <label>人生经历时间线</label>
    <textarea id="timeline" rows="4" placeholder="例如：22岁毕业 → 第一份工作3年 → 转行失败 → 当前迷茫"></textarea>

    <label>想回到的时间点</label>
    <input id="rewind" placeholder="例如：24岁，是否换城市">

    <label>能力 / 资源（可选）</label>
    <input id="traits" placeholder="例如：执行力中等，家庭支持有限">

    <button id="runBtn">开始模拟</button>

    <div id="status" class="status" style="margin-top:10px">
      <strong>状态：</strong>等待输入
    </div>
  </div>

  <div id="result"></div>

  <footer>
    RE:LIFE 提供的是基于用户输入的情景推演与理性分析，不构成现实建议、预测或保证。<br/>
    用户需对自身人生决策负责。
  </footer>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  const personaEl = $("persona");
  const timelineEl = $("timeline");
  const rewindEl  = $("rewind");
  const traitsEl  = $("traits");
  const runBtn    = $("runBtn");
  const statusEl  = $("status");
  const resultEl  = $("result");

  let history = [];

  function setStatus(text, cls){
    statusEl.className = "status " + (cls || "");
    statusEl.innerHTML = "<strong>状态：</strong>" + text;
  }

  function safeText(v){ return (v ?? "").toString(); }

  runBtn.addEventListener("click", runSim);

  async function runSim(){
    try{
      // 基础校验（避免空提交让你误判“没反应”）
      if(!safeText(personaEl.value).trim() || !safeText(timelineEl.value).trim() || !safeText(rewindEl.value).trim()){
        setStatus("请至少填写：个人背景 / 经历时间线 / 回到时间点", "error");
        return;
      }

      runBtn.disabled = true;
      runBtn.textContent = "推演中…";
      setStatus("请求已发出：POST /api/generate", "");

      const payload = {
        persona: personaEl.value,
        timeline: timelineEl.value,
        rewind_point: rewindEl.value,
        traits: traitsEl.value,
        history
      };

      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      // 先读文本，再尝试 JSON（这样即使后端返回非 JSON 也能显示出来）
      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch {}

      if(!res.ok){
        setStatus(`HTTP ${res.status}：${raw.slice(0,200)}`, "error");
        return;
      }

      if(!data || data.success !== true){
        setStatus(`后端返回格式不符合预期：${raw.slice(0,200)}`, "error");
        return;
      }

      // 成功
      setStatus("推演成功 ✅", "ok");
      history.push({ role:"assistant", content: JSON.stringify(data.data) });
      render(data.data);

    }catch(e){
      console.error(e);
      setStatus("前端异常：" + (e?.message || e), "error");
    }finally{
      runBtn.disabled = false;
      runBtn.textContent = "开始模拟";
    }
  }

  function render(d){
    resultEl.innerHTML = "";

    const branches = Array.isArray(d?.branches) ? d.branches : [];
    if(branches.length === 0){
      resultEl.innerHTML = `<div class="card"><b>没有分支数据</b><div class="small">请检查后端是否输出了 branches[]</div></div>`;
      return;
    }

    branches.forEach((b,i)=>{
      const risks = Array.isArray(b?.risks) ? b.risks.join("、") : safeText(b?.risks);
      resultEl.innerHTML += `
        <div class="card branch">
          <h3>分支 ${i+1}：${safeText(b?.title)}</h3>
          <div class="kv"><b>关键选择：</b>${safeText(b?.key_choice)}</div>
          <div class="kv"><b>中期结果：</b>${safeText(b?.mid_result)}</div>
          <div class="kv"><b>长期走向：</b>${safeText(b?.long_term)}</div>
          <div class="kv"><b>概率区间：</b>${safeText(b?.probability)}</div>
          <div class="kv"><b>主要风险：</b>${risks}</div>
          <div class="small">因果解释：${safeText(b?.why)}</div>
        </div>
      `;
    });

    const overall = Array.isArray(d?.overall_risks) ? d.overall_risks.join("、") : safeText(d?.overall_risks);
    resultEl.innerHTML += `
      <div class="card">
        <b>整体风险提示：</b> ${overall || "（未提供）"}
        <p class="small">${safeText(d?.summary)}</p>
      </div>
    `;
  }
</script>
</body>
</html>
