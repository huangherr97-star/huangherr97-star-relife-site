<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RE:LIFE | å›ç¯</title>
  <meta name="description" content="ç†æ€§äººç”Ÿæ¨¡æ‹Ÿ Â· éç®—å‘½ Â· éä¿è¯" />
  <style>
    :root{
      --bg:#0B1220;
      --card:#0F1A2E;
      --card2:#0D1628;
      --text:#E6EEF9;
      --muted:#9DB0CC;
      --line:rgba(255,255,255,.08);
      --primary:#4C6FFF;
      --cyan:#22D3EE;
      --warn:#F59E0B;
      --danger:#FB7185;
      --ok:#34D399;
      --shadow: 0 24px 60px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 15% 20%, rgba(34,211,238,.16), transparent 60%),
        radial-gradient(900px 500px at 75% 10%, rgba(76,111,255,.14), transparent 60%),
        radial-gradient(700px 400px at 70% 80%, rgba(245,158,11,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 40px 16px 60px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    h1{
      margin:0;
      font-size: 44px;
      letter-spacing: 1px;
      font-weight: 800;
    }
    .sub{
      margin-top:8px;
      color:var(--muted);
      font-size: 14px;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .9fr;
      gap: 16px;
      margin-top: 18px;
    }
    @media (max-width: 960px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column; align-items:flex-start}
      h1{font-size: 34px;}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .inner{ padding: 18px; }
    .title{
      font-weight: 800;
      font-size: 18px;
      margin: 4px 0 14px;
    }
    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input, textarea, select{
      width:100%;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      border-radius: 12px;
      color: var(--text);
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      transition: border .15s ease, box-shadow .15s ease;
    }
    textarea{ min-height: 120px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(76,111,255,.55);
      box-shadow: 0 0 0 3px rgba(76,111,255,.18);
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 600px){
      .row2{grid-template-columns:1fr}
    }
    .btnbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
      align-items:center;
    }
    button{
      border:0;
      cursor:pointer;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 800;
      color: #fff;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      transition: transform .06s ease, opacity .15s ease, background .15s ease, border .15s ease;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    .primary{
      background: linear-gradient(90deg, rgba(76,111,255,.95), rgba(76,111,255,.75));
      border-color: rgba(76,111,255,.45);
    }
    .ghost{
      background: rgba(255,255,255,.04);
    }
    .danger{
      background: rgba(251,113,133,.10);
      border-color: rgba(251,113,133,.35);
      color: #ffd1da;
    }
    .small{
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 999px;
      font-weight: 700;
    }
    .note{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.5;
    }
    .status{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      white-space: pre-wrap;
      word-break: break-word;
      border-top: 1px solid var(--line);
      padding-top: 10px;
    }
    .ok{ color: var(--ok); }
    .err{ color: var(--danger); }
    .warn{ color: var(--warn); }

    .panel{
      background: rgba(0,0,0,.14);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      padding: 14px;
      min-height: 400px;
      overflow:auto;
    }
    .panel pre{
      margin:0;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.55;
      color: #dbe7ff;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .hr{
      height:1px;
      background: var(--line);
      margin: 18px 0;
    }
    footer{
      margin-top: 18px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
      opacity: .9;
    }
    .kbd{
      font-family: var(--mono);
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 2px 6px;
      font-size: 12px;
      color: #cfe0ff;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>RE:LIFE | å›ç¯</h1>
        <div class="sub">ç†æ€§äººç”Ÿæ¨¡æ‹Ÿ Â· éç®—å‘½ Â· éä¿è¯</div>
      </div>
      <div class="badge">API: <span class="kbd" id="apiBadge">/api/generate</span></div>
    </header>

    <div class="grid">
      <!-- LEFT: input -->
      <div class="card">
        <div class="inner">
          <div class="title">ä½ çš„ä¿¡æ¯</div>

          <label for="background">ä¸ªäººèƒŒæ™¯ï¼ˆå¿…å¡«ï¼‰</label>
          <input id="background" placeholder="ä¾‹å¦‚ï¼š28å²ï¼Œå·¥ä½œ3å¹´ï¼Œæƒ³è½¬è¡Œ/åˆ›ä¸š/è€ƒç ”..." />

          <label for="timeline">äººç”Ÿç»å†æ—¶é—´çº¿ï¼ˆå¿…å¡«ï¼Œè¶Šå…·ä½“è¶Šå¥½ï¼‰</label>
          <textarea id="timeline" placeholder="æŒ‰æ—¶é—´å†™ï¼š\n- 2015ï¼š...\n- 2018ï¼š...\n- 2021ï¼š...\nï¼ˆå…³é”®äº‹ä»¶/é€‰æ‹©/ç»“æœ/åŸå› ï¼‰"></textarea>

          <div class="row2">
            <div>
              <label for="target">æƒ³å›åˆ°çš„æ—¶é—´ç‚¹ï¼ˆå¿…å¡«ï¼‰</label>
              <input id="target" placeholder="ä¾‹å¦‚ï¼š18å²é«˜è€ƒã€æ¯•ä¸šé‚£å¹´ã€å…¥èŒå‰..." />
            </div>
            <div>
              <label for="mode">ç”Ÿæˆæ¨¡å¼</label>
              <select id="mode">
                <option value="compare" selected>å¯¹æ¯” A/B/Cï¼ˆæ¨èï¼‰</option>
                <option value="single">å•ä¸€è·¯å¾„ï¼ˆæ›´æ·±å…¥ï¼‰</option>
                <option value="chat">å¯¹è¯æ¨¡å¼ï¼ˆåç»­è¿½é—®ï¼‰</option>
              </select>
            </div>
          </div>

          <label for="resources">èƒ½åŠ› / èµ„æºï¼ˆå¯é€‰ï¼‰</label>
          <input id="resources" placeholder="ä¾‹å¦‚ï¼šè‹±è¯­ã€ä»£ç åŸºç¡€ã€äººè„‰ã€å­˜æ¬¾ã€å¯å­¦ä¹ æ—¶é—´..." />

          <div class="btnbar">
            <button class="primary" id="btnRun">å¼€å§‹æ¨¡æ‹Ÿ</button>
            <button class="ghost" id="btnShare">ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
            <button class="danger" id="btnClear">æ¸…ç©º</button>
          </div>

          <div class="note">
            æç¤ºï¼šå¦‚æœä½ çœ‹åˆ° <span class="kbd">HTTP 400 Missing required fields</span>ï¼Œ
            è¯´æ˜è¯·æ±‚ä½“ç¼ºå°‘ <span class="kbd">background / timeline / target</span>ã€‚
            æœ¬é¡µé¢ä¼šè‡ªåŠ¨æ£€æŸ¥å¿…å¡«é¡¹å¹¶æç¤ºã€‚
          </div>

          <div class="status" id="status">çŠ¶æ€ï¼šå°±ç»ª</div>
        </div>
      </div>

      <!-- RIGHT: output -->
      <div class="card">
        <div class="inner">
          <div class="title">ç»“æœ</div>
          <div class="panel" id="panel">
            <pre id="output"></pre>
          </div>

          <div class="tools">
            <button class="small ghost" id="btnExpand">å…¨éƒ¨å±•å¼€</button>
            <button class="small ghost" id="btnCollapse">å…¨éƒ¨æŠ˜å </button>
            <button class="small ghost" id="btnCopy">å¤åˆ¶å…¨éƒ¨</button>
            <button class="small ghost" id="btnPing">æµ‹è¯• APIï¼ˆ/api/pingï¼‰</button>
          </div>

          <div class="hr"></div>

          <div class="title" style="margin-top:0;">å¯¹è¯æ¨¡å¼ï¼ˆå¯é€‰ï¼‰</div>
          <div class="note" style="margin-top:-6px;">
            å¯¹è¯æ¨¡å¼ï¼šåŸºäºä½ åˆšåˆšçš„è¾“å…¥ + ç»“æœç»§ç»­è¿½é—®ã€‚ä¸å«â€œç®—å‘½â€ï¼Œåªåšç†æ€§æ¨æ¼”ã€‚
          </div>
          <label for="chatInput" style="margin-top:10px;">è¿½é—®</label>
          <input id="chatInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ›´é€‚åˆç»§ç»­è¯»ä¹¦å—ï¼Ÿæœ€å°é£é™©æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ" />
          <div class="btnbar" style="margin-top:10px;">
            <button class="primary" id="btnChat">å‘é€</button>
            <button class="ghost" id="btnChatClear">æ¸…ç©ºå¯¹è¯</button>
          </div>
          <div class="note">å¯¹è¯ä¸Šä¸‹æ–‡ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰ã€‚</div>
        </div>
      </div>
    </div>

    <footer>
      RE:LIFE æä¾›çš„æ˜¯åŸºäºç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯æ¨æ¼”ä¸ç†æ€§åˆ†æï¼Œä¸æ„æˆç°å®å»ºè®®ã€é¢„æµ‹æˆ–ä¿è¯ã€‚ä½ å¯¹è‡ªå·±çš„é€‰æ‹©è´Ÿè´£ã€‚
    </footer>
  </div>

<script>
/** =========================
 *  Utils
 *  ========================= */
const $ = (id) => document.getElementById(id);
const STORAGE_KEY = "relife_state_v1";
const CHAT_KEY = "relife_chat_v1";

function safeText(str){
  // é˜²æ­¢æŠŠè¿”å›å†…å®¹å½“ HTML æ‰§è¡Œ
  return String(str ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function setStatus(text, type=""){
  const el = $("status");
  el.className = "status";
  if(type==="ok") el.classList.add("ok");
  if(type==="err") el.classList.add("err");
  if(type==="warn") el.classList.add("warn");
  el.textContent = text;
}

function nowISO(){
  return new Date().toISOString();
}

function readForm(){
  return {
    background: $("background").value.trim(),
    timeline: $("timeline").value.trim(),
    target: $("target").value.trim(),
    resources: $("resources").value.trim(),
    mode: $("mode").value
  };
}

function validateRequired(payload){
  const need = [];
  if(!payload.background) need.push("background");
  if(!payload.timeline) need.push("timeline");
  if(!payload.target) need.push("target");
  return need;
}

function saveState(){
  const payload = readForm();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
}

function loadState(){
  const q = new URLSearchParams(location.search);
  const hasShare = q.has("background") || q.has("timeline") || q.has("target");
  if(hasShare){
    $("background").value = q.get("background") || "";
    $("timeline").value = q.get("timeline") || "";
    $("target").value = q.get("target") || "";
    $("resources").value = q.get("resources") || "";
    $("mode").value = q.get("mode") || "compare";
    return;
  }
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    $("background").value = s.background || "";
    $("timeline").value = s.timeline || "";
    $("target").value = s.target || "";
    $("resources").value = s.resources || "";
    $("mode").value = s.mode || "compare";
  }catch{}
}

function saveChat(messages){
  localStorage.setItem(CHAT_KEY, JSON.stringify(messages));
}
function loadChat(){
  try{
    const raw = localStorage.getItem(CHAT_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch{
    return [];
  }
}

/** =========================
 *  Render helpers
 *  ========================= */
function setOutput(text){
  $("output").innerHTML = safeText(text);
  $("panel").scrollTop = 0;
}

// âœ… ä¿®å¤ç‰ˆï¼šä¸è¦å†™é”™æ‹¬å·ï¼Œé¿å…ä½ ä¹‹å‰çš„æ­£åˆ™å´©æºƒ
// è¿™ä¸ªæ­£åˆ™ç”¨äºæ£€æµ‹â€œè¡Œé¦–çš„ 1) / 2) / ### æ ‡é¢˜â€ç­‰æ ‡è®°
const MARK_RE = /^(?:\d+\)|#+)/;

function collapseMarkdown(text){
  // ç®€æ˜“æŠ˜å ï¼šä¿ç•™æ ‡é¢˜è¡Œ + åˆ—è¡¨å¼€å¤´ï¼Œå…¶ä½™å‹ç¼©
  const lines = String(text || "").split("\n");
  const out = [];
  for(const line of lines){
    const t = line.trim();
    if(!t){
      out.push("");
      continue;
    }
    if(MARK_RE.test(t) || t.startsWith("- ") || t.startsWith("* ")){
      out.push(line);
    }else{
      // æŠ˜å æ™®é€šæ®µè½ï¼šåªç•™å‰ 1 è¡Œ
      if(out.length===0 || out[out.length-1] !== "â€¦"){
        out.push("â€¦");
      }
    }
  }
  return out.join("\n");
}

function expandMarkdown(text){
  return String(text || "");
}

/** =========================
 *  API calls
 *  ========================= */
async function apiPost(url, payload){
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  const ct = res.headers.get("content-type") || "";
  const isJson = ct.includes("application/json");

  let dataText = "";
  let dataJson = null;

  if(isJson){
    try{
      dataJson = await res.json();
    }catch(e){
      dataText = await res.text();
    }
  }else{
    dataText = await res.text();
  }

  if(!res.ok){
    const msg = dataJson ? JSON.stringify(dataJson) : dataText;
    const err = new Error(`HTTP ${res.status}: ${msg}`);
    err.status = res.status;
    err.payload = dataJson;
    throw err;
  }

  return dataJson ?? dataText;
}

function normalizeResult(resp){
  // å…¼å®¹ä¸åŒåç«¯è¿”å›ç»“æ„
  if(resp == null) return "";
  if(typeof resp === "string") return resp;

  // å¸¸è§å­—æ®µï¼š{ text }, { result }, { output }, { data:{...} }
  if(resp.text) return String(resp.text);
  if(resp.result) return String(resp.result);
  if(resp.output) return String(resp.output);
  if(resp.data && typeof resp.data === "string") return resp.data;

  // OpenAI proxy å¸¸è§ï¼š{ choices:[{message:{content}}] }
  try{
    const c = resp.choices?.[0]?.message?.content;
    if(c) return String(c);
  }catch{}

  return JSON.stringify(resp, null, 2);
}

/** =========================
 *  Main actions
 *  ========================= */
let lastFullText = "";
let isCollapsed = false;

async function runSimulate(extra = {}){
  const base = readForm();
  const payload = { ...base, ...extra };

  // required check
  const need = validateRequired(payload);
  if(need.length){
    setStatus(`çŠ¶æ€ï¼šç¼ºå°‘å¿…å¡«é¡¹ -> ${need.join(", ")}`, "warn");
    return;
  }

  saveState();

  const apiUrl = "/api/generate";
  $("apiBadge").textContent = apiUrl;

  try{
    setStatus("çŠ¶æ€ï¼šè¯·æ±‚ä¸­â€¦", "");
    $("btnRun").disabled = true;
    $("btnRun").style.opacity = ".7";
    setOutput("â³ æ­£åœ¨ç”Ÿæˆâ€¦\n\nï¼ˆå¦‚æœ 10-20 ç§’æ— è¿”å›ï¼Œæ£€æŸ¥ Vercel Function Logsï¼‰");

    const resp = await apiPost(apiUrl, payload);
    const text = normalizeResult(resp);

    lastFullText = text;
    isCollapsed = false;
    setOutput(text);
    setStatus(`çŠ¶æ€ï¼šæˆåŠŸ Â· ${nowISO()}`, "ok");
  }catch(err){
    lastFullText = "";
    const msg = err?.message || String(err);
    setStatus("çŠ¶æ€ï¼šå¤±è´¥ï¼ˆæŸ¥çœ‹ä¸‹æ–¹é”™è¯¯ï¼‰", "err");
    setOutput(
      `âŒ è¯·æ±‚å¤±è´¥\n\n` +
      `- ${msg}\n\n` +
      `å¦‚æœä½ çœ‹åˆ° 400 Missing required fieldsï¼šè¯·ç¡®è®¤è¯·æ±‚ä½“åŒ…å« background/timeline/targetã€‚\n` +
      `å¦‚æœä½ çœ‹åˆ° 405ï¼šé€šå¸¸æ˜¯è·¯ç”±/æ–¹æ³•ä¸åŒ¹é…æˆ–ä¸æ˜¯ Functionã€‚\n` +
      `å¦‚æœä½ çœ‹åˆ° 404 NOT_FOUNDï¼šé€šå¸¸æ˜¯ /api è·¯ç”±æœªéƒ¨ç½²æˆåŠŸã€‚\n`
    );
  }finally{
    $("btnRun").disabled = false;
    $("btnRun").style.opacity = "1";
  }
}

async function pingApi(){
  try{
    setStatus("çŠ¶æ€ï¼šæµ‹è¯• /api/ping â€¦", "");
    const res = await fetch("/api/ping", { method:"GET" });
    const text = await res.text();
    if(!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
    setStatus("çŠ¶æ€ï¼š/api/ping OK", "ok");
    setOutput(`âœ… /api/ping è¿”å›ï¼š\n\n${text}`);
  }catch(e){
    setStatus("çŠ¶æ€ï¼š/api/ping å¤±è´¥", "err");
    setOutput(`âŒ /api/ping å¤±è´¥\n\n${String(e?.message || e)}`);
  }
}

function shareLink(){
  const p = readForm();
  const need = validateRequired(p);
  if(need.length){
    setStatus(`çŠ¶æ€ï¼šæ— æ³•ç”Ÿæˆé“¾æ¥ï¼Œç¼ºå°‘ï¼š${need.join(", ")}`, "warn");
    return;
  }
  const q = new URLSearchParams();
  q.set("background", p.background);
  q.set("timeline", p.timeline);
  q.set("target", p.target);
  if(p.resources) q.set("resources", p.resources);
  if(p.mode) q.set("mode", p.mode);
  const url = `${location.origin}${location.pathname}?${q.toString()}`;
  navigator.clipboard?.writeText(url).catch(()=>{});
  setStatus("çŠ¶æ€ï¼šåˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "ok");
  setOutput(`ğŸ”— åˆ†äº«é“¾æ¥ï¼ˆå·²å¤åˆ¶ï¼‰ï¼š\n\n${url}`);
}

function clearAll(){
  $("background").value = "";
  $("timeline").value = "";
  $("target").value = "";
  $("resources").value = "";
  $("mode").value = "compare";
  localStorage.removeItem(STORAGE_KEY);
  setStatus("çŠ¶æ€ï¼šå·²æ¸…ç©º", "ok");
  lastFullText = "";
  setOutput("");
}

function toggleCollapse(collapse){
  if(!lastFullText){
    setStatus("çŠ¶æ€ï¼šæ²¡æœ‰å¯æŠ˜å å†…å®¹", "warn");
    return;
  }
  if(collapse){
    setOutput(collapseMarkdown(lastFullText));
    isCollapsed = true;
    setStatus("çŠ¶æ€ï¼šå·²æŠ˜å æ˜¾ç¤º", "ok");
  }else{
    setOutput(expandMarkdown(lastFullText));
    isCollapsed = false;
    setStatus("çŠ¶æ€ï¼šå·²å±•å¼€æ˜¾ç¤º", "ok");
  }
}

async function copyAll(){
  const text = lastFullText || $("output").innerText || "";
  if(!text){
    setStatus("çŠ¶æ€ï¼šæ²¡æœ‰å¯å¤åˆ¶å†…å®¹", "warn");
    return;
  }
  try{
    await navigator.clipboard.writeText(text);
    setStatus("çŠ¶æ€ï¼šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "ok");
  }catch{
    setStatus("çŠ¶æ€ï¼šå¤åˆ¶å¤±è´¥ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰", "err");
  }
}

/** =========================
 *  Chat mode
 *  ========================= */
async function sendChat(){
  const q = $("chatInput").value.trim();
  if(!q){
    setStatus("çŠ¶æ€ï¼šè¯·è¾“å…¥è¿½é—®å†…å®¹", "warn");
    return;
  }
  const base = readForm();
  const need = validateRequired(base);
  if(need.length){
    setStatus(`çŠ¶æ€ï¼šè¯·å…ˆå®Œæˆå¿…å¡«é¡¹å¹¶ç”Ÿæˆä¸€æ¬¡ç»“æœï¼ˆç¼ºå°‘ï¼š${need.join(", ")}ï¼‰`, "warn");
    return;
  }

  const messages = loadChat();
  // è¿½åŠ å½“å‰ä¸Šä¸‹æ–‡ï¼ˆè½»é‡ï¼‰
  messages.push({ role:"user", content: q, at: nowISO() });
  saveChat(messages);

  try{
    setStatus("çŠ¶æ€ï¼šå¯¹è¯è¯·æ±‚ä¸­â€¦", "");
    $("btnChat").disabled = true;
    $("btnChat").style.opacity = ".7";

    const payload = {
      ...base,
      mode: "chat",
      question: q,
      history: messages.slice(-10) // åªå¸¦æœ€è¿‘10æ¡
    };

    const resp = await apiPost("/api/generate", payload);
    const text = normalizeResult(resp);

    messages.push({ role:"assistant", content: text, at: nowISO() });
    saveChat(messages);

    // å°†å¯¹è¯å†…å®¹è¿½åŠ å±•ç¤ºåœ¨è¾“å‡ºåŒºï¼ˆä¸è¦†ç›–ä¹‹å‰ç»“æœä¹Ÿå¯ï¼Œè¿™é‡Œåšè¿½åŠ æ›´ç›´è§‚ï¼‰
    const combined = (lastFullText ? (lastFullText + "\n\n---\n\n") : "") +
      `ã€è¿½é—®ã€‘${q}\n\nã€å›ç­”ã€‘\n${text}`;
    lastFullText = combined;
    setOutput(isCollapsed ? collapseMarkdown(lastFullText) : lastFullText);
    setStatus("çŠ¶æ€ï¼šå¯¹è¯æˆåŠŸ", "ok");
    $("chatInput").value = "";
  }catch(err){
    setStatus("çŠ¶æ€ï¼šå¯¹è¯å¤±è´¥ï¼ˆæŸ¥çœ‹ä¸‹æ–¹ï¼‰", "err");
    setOutput(`âŒ å¯¹è¯è¯·æ±‚å¤±è´¥\n\n${String(err?.message || err)}`);
  }finally{
    $("btnChat").disabled = false;
    $("btnChat").style.opacity = "1";
  }
}

function clearChat(){
  localStorage.removeItem(CHAT_KEY);
  setStatus("çŠ¶æ€ï¼šå¯¹è¯å·²æ¸…ç©º", "ok");
}

/** =========================
 *  Bind
 *  ========================= */
(function init(){
  loadState();

  $("btnRun").addEventListener("click", () => runSimulate());
  $("btnShare").addEventListener("click", shareLink);
  $("btnClear").addEventListener("click", clearAll);

  $("btnExpand").addEventListener("click", () => toggleCollapse(false));
  $("btnCollapse").addEventListener("click", () => toggleCollapse(true));
  $("btnCopy").addEventListener("click", copyAll);
  $("btnPing").addEventListener("click", pingApi);

  $("btnChat").addEventListener("click", sendChat);
  $("btnChatClear").addEventListener("click", clearChat);

  // è‡ªåŠ¨ä¿å­˜è¾“å…¥
  ["background","timeline","target","resources","mode"].forEach(id=>{
    $(id).addEventListener("input", saveState);
    $(id).addEventListener("change", saveState);
  });

  // Enter to send chat
  $("chatInput").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      sendChat();
    }
  });

  setStatus("çŠ¶æ€ï¼šå°±ç»ª", "ok");
})();
</script>
</body>
</html>
