<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RE:LIFE | å›ç¯</title>
    <link rel="icon" href="/favicon.ico" />

    <!-- Chart.js for radar chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --bg-soft: #111827;
            --card: #020617;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.15);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: #1f2937;
            --danger: #f97373;
            --success: #4ade80;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 18px 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(12px);
            background: linear-gradient(to right, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.6));
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-mark {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #38bdf8, #0ea5e9, #1d4ed8);
            box-shadow: 0 0 18px rgba(56, 189, 248, 0.7);
        }

        .logo-text-main {
            font-weight: 700;
            letter-spacing: 0.08em;
            font-size: 14px;
            text-transform: uppercase;
        }

        .logo-text-sub {
            font-size: 12px;
            color: var(--muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pill {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            font-size: 11px;
            color: var(--muted);
        }

        .container {
            flex: 1;
            display: flex;
            padding: 18px;
            gap: 18px;
        }

        .column {
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%),
                        radial-gradient(circle at bottom right, rgba(129, 140, 248, 0.12), transparent 55%),
                        var(--bg-soft);
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
            animation: cardIn 0.5s ease-out;
        }

        .column-left {
            flex: 0 0 40%;
            min-width: 320px;
        }

        .column-right {
            flex: 1;
            min-width: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title span {
            font-size: 11px;
            text-transform: none;
            color: var(--muted);
        }

        label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
            color: #e5e7eb;
        }

        .field-hint {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        textarea, input, select {
            width: 100%;
            padding: 9px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text);
            font-size: 13px;
            resize: vertical;
            min-height: 60px;
            outline: none;
            transition: border 0.15s, box-shadow 0.15s, background 0.15s;
        }

        textarea:focus, input:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
            background: rgba(15, 23, 42, 1);
        }

        .field-group {
            margin-bottom: 10px;
        }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
        }

        button {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text);
            padding: 7px 14px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s, box-shadow 0.15s, border 0.15s;
        }

        button.primary {
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            border-color: rgba(56, 189, 248, 0.9);
            color: #0b1120;
            font-weight: 600;
            box-shadow: 0 8px 20px rgba(56, 189, 248, 0.4);
        }

        button.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 28px rgba(56, 189, 248, 0.55);
        }

        button.secondary:hover {
            background: rgba(30, 64, 175, 0.7);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .btn-icon {
            font-size: 14px;
        }

        .loading {
            display: none;
            font-size: 12px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
        }

        .spinner {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            border: 2px solid rgba(148, 163, 184, 0.4);
            border-top-color: var(--accent);
            animation: spin 0.7s linear infinite;
        }

        .output-card {
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%),
                        radial-gradient(circle at bottom right, rgba(129, 140, 248, 0.12), transparent 55%),
                        var(--card);
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            padding: 14px 14px 10px;
            min-height: 120px;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 260px;
            opacity: 0;
            transform: translateY(6px);
            animation: fadeUp 0.35s ease-out forwards;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .output-title {
            font-size: 12px;
            color: var(--muted);
        }

        .tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--muted);
        }

        .history-list {
            margin-top: 10px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(15, 23, 42, 0.9);
            max-height: 160px;
            overflow-y: auto;
        }

        .history-item {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(31, 41, 55, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: rgba(30, 64, 175, 0.6);
        }

        .history-item.active {
            background: rgba(30, 64, 175, 0.9);
        }

        .history-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .history-title {
            font-weight: 500;
        }

        .history-sub {
            color: var(--muted);
            font-size: 11px;
        }

        .history-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .score-panel {
            margin-top: 10px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            padding: 10px;
            background: rgba(15, 23, 42, 0.9);
            font-size: 11px;
        }

        .score-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .score-row label {
            margin: 0;
            min-width: 70px;
            font-size: 11px;
        }

        .score-row input[type="range"] {
            flex: 1;
        }

        .score-value {
            width: 20px;
            text-align: right;
            color: var(--muted);
        }

        .chart-card {
            margin-top: 10px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            padding: 10px;
            background: rgba(15, 23, 42, 0.9);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 999px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes cardIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            .column-left {
                flex: none;
                width: 100%;
            }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <div class="logo-mark"></div>
        <div>
            <div class="logo-text-main">RE:LIFE</div>
            <div class="logo-text-sub">å›ç¯äººç”Ÿæ¨¡æ‹Ÿ Â· Reset Life Loop</div>
        </div>
    </div>
    <div class="header-right">
        <div class="pill">v1.1 Â· Multi-run Â· Radar Scoring</div>
    </div>
</header>

<div class="container">
    <!-- å·¦ä¾§ï¼šè¾“å…¥åŒº -->
    <div class="column column-left">
        <div class="section-title">
            è¾“å…¥ä½ çš„å½“å‰äººç”Ÿ
            <span>4 ä¸ªå­—æ®µ Â· 30 ç§’å†…å®Œæˆ</span>
        </div>

        <div class="field-group">
            <label>ä¸ªäººèƒŒæ™¯</label>
            <div class="field-hint">ä¾‹å¦‚ï¼šäº’è”ç½‘äº§å“ç»ç† / äºŒçº¿åŸå¸‚ / å·¥ä½œ 5 å¹´ï¼Œå¯¹æœªæ¥æœ‰ç‚¹è¿·èŒ«</div>
            <textarea id="field-background"></textarea>
        </div>

        <div class="field-group">
            <label>å¹´é¾„ã€å­¦å†ã€åŸå¸‚å±‚çº§ï¼ˆå¯æ¨¡ç³Šï¼‰</label>
            <div class="field-hint">ä¾‹å¦‚ï¼š29 å²ï¼Œæœ¬ç§‘ï¼ŒäºŒçº¿åŸå¸‚ï¼›æˆ–ã€Œå¿« 30 äº†ï¼Œæœ¬ç§‘ï¼ŒåŒ—æ¼‚ã€</div>
            <textarea id="field-basic"></textarea>
        </div>

        <div class="field-group">
            <label>äººç”Ÿç»å†æ—¶é—´çº¿ï¼ˆå…³é”®èŠ‚ç‚¹ï¼‰</label>
            <div class="field-hint">ä¾‹å¦‚ï¼š18 å²é«˜è€ƒ / 22 å²æ¯•ä¸š / 24 å²è½¬è¡Œ / 27 å²è£¸è¾</div>
            <textarea id="field-timeline"></textarea>
        </div>

        <div class="field-group">
            <label>æƒ³å›åˆ°çš„æ—¶é—´ç‚¹ï¼ˆæ˜ç¡®åˆ°å¹´é¾„æˆ–å¹´ä»½ï¼‰</label>
            <div class="field-hint">ä¾‹å¦‚ï¼š24 å²åˆšæ¯•ä¸šé‚£ä¸€å¹´ï¼›æˆ–ã€Œ2018 å¹´åˆšå…¥èŒç¬¬ä¸€ä»½å·¥ä½œçš„æ—¶å€™ã€</div>
            <textarea id="field-target"></textarea>
        </div>

        <div class="field-group">
            <label>èƒ½åŠ› / èµ„æºï¼ˆå¯é€‰ï¼‰</label>
            <div class="field-hint">ä¾‹å¦‚ï¼šå†™ä½œèƒ½åŠ›å¼º / å®¶åº­æ”¯æŒä¸€èˆ¬ / æ€§æ ¼åå†…å‘ä½†æ‰§è¡ŒåŠ›å¼º</div>
            <textarea id="field-skills"></textarea>
        </div>

        <div class="field-group">
            <label>æ¨¡å¼é€‰æ‹©</label>
            <select id="field-mode">
                <option value="abc">A/B/C ä¸‰è·¯çº¿å¯¹æ¯”</option>
                <option value="single">å•è·¯çº¿æ·±æ</option>
                <option value="chat">è¿ç»­å¯¹è¯æ¢ç´¢</option>
            </select>
        </div>

        <div class="btn-row">
            <button class="primary" id="btn-generate">
                <span class="btn-icon">â–¶</span>
                ç”Ÿæˆæ¨¡æ‹Ÿ
            </button>
            <button class="secondary" id="btn-clear">
                <span class="btn-icon">ğŸ§¹</span>
                æ¸…ç©ºå½“å‰ç»“æœ
            </button>
            <button class="secondary" id="btn-export">
                <span class="btn-icon">ğŸ“„</span>
                å¯¼å‡ºå½“å‰ä¸º PDF
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span>æ­£åœ¨å›ç¯ä½ çš„æ—¶é—´çº¿...</span>
        </div>
    </div>

    <!-- å³ä¾§ï¼šç»“æœ + å†å² + é›·è¾¾å›¾ -->
    <div class="column column-right">
        <div class="section-title">
            å½“å‰æ¨¡æ‹Ÿç»“æœ
            <span id="current-run-label">å°šæœªç”Ÿæˆ</span>
        </div>

        <div id="output-wrapper" style="display:none;">
            <div class="output-card" id="output-card">
                <div class="output-header">
                    <div class="output-title" id="output-title">è·¯çº¿ç»“æœ</div>
                    <div class="tag" id="output-tag">A/B/C å¯¹æ¯”</div>
                </div>
                <div id="output-text"></div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
                <button class="secondary" id="btn-copy">
                    <span class="btn-icon">ğŸ“‹</span>
                    å¤åˆ¶ç»“æœ
                </button>
                <button class="secondary" id="btn-open-window">
                    <span class="btn-icon">ğŸªŸ</span>
                    åœ¨æ–°çª—å£æŸ¥çœ‹
                </button>
            </div>

            <div class="score-panel">
                <div style="margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
                    <span>ä¸ºå½“å‰è¿™æ¬¡æ¨¡æ‹Ÿæ‰“åˆ†ï¼ˆ1-10ï¼‰</span>
                    <span style="color:var(--muted);">ç”¨äºé›·è¾¾å›¾å¯¹æ¯”ä¸åŒæ¨¡æ‹Ÿ</span>
                </div>
                <div class="score-row">
                    <label>æ•´ä½“æ»¡æ„åº¦</label>
                    <input type="range" min="1" max="10" value="7" id="score-satisfaction" />
                    <div class="score-value" id="score-satisfaction-val">7</div>
                </div>
                <div class="score-row">
                    <label>ç¨³å®šæ€§</label>
                    <input type="range" min="1" max="10" value="7" id="score-stability" />
                    <div class="score-value" id="score-stability-val">7</div>
                </div>
                <div class="score-row">
                    <label>æˆé•¿æ€§</label>
                    <input type="range" min="1" max="10" value="7" id="score-growth" />
                    <div class="score-value" id="score-growth-val">7</div>
                </div>
                <div class="score-row">
                    <label>è‡ªç”±åº¦</label>
                    <input type="range" min="1" max="10" value="7" id="score-freedom" />
                    <div class="score-value" id="score-freedom-val">7</div>
                </div>
                <div class="score-row">
                    <label>å…³ç³»è´¨é‡</label>
                    <input type="range" min="1" max="10" value="7" id="score-relationship" />
                    <div class="score-value" id="score-relationship-val">7</div>
                </div>
                <div class="btn-row" style="margin-top:4px;">
                    <button class="secondary" id="btn-save-score">
                        <span class="btn-icon">ğŸ’¾</span>
                        ä¿å­˜å½“å‰è¯„åˆ†åˆ°é›·è¾¾å›¾
                    </button>
                </div>
            </div>
        </div>

        <div class="section-title" style="margin-top:4px;">
            å†å²æ¨¡æ‹Ÿ
            <span>ç‚¹å‡»åˆ‡æ¢æŸ¥çœ‹ Â· æœ€å¤šä¿ç•™ 10 æ¡</span>
        </div>
        <div class="history-list" id="history-list"></div>

        <div class="chart-card">
            <div class="chart-header">
                <span>å¤šæ¬¡æ¨¡æ‹Ÿé›·è¾¾å›¾å¯¹æ¯”</span>
                <span id="chart-hint">ä¿å­˜è¯„åˆ†åè‡ªåŠ¨æ›´æ–°</span>
            </div>
            <canvas id="radarChart" height="180"></canvas>
            <div class="chart-legend" id="chart-legend"></div>
        </div>
    </div>
</div>

<script>
    // å…¨å±€çŠ¶æ€
    const state = {
        runs: [],          // { id, title, mode, timestamp, resultText, scores }
        currentRunId: null,
        radarChart: null
    };

    function createRunTitle(index, mode) {
        const n = index + 1;
        const modeText = mode === "abc" ? "A/B/C" : (mode === "single" ? "å•è·¯çº¿" : "å¯¹è¯");
        return "ç¬¬ " + n + " æ¬¡ Â· " + modeText;
    }

    function formatTime(ts) {
        const d = new Date(ts);
        const h = String(d.getHours()).padStart(2, "0");
        const m = String(d.getMinutes()).padStart(2, "0");
        return h + ":" + m;
    }

    function getCurrentScoresFromUI() {
        return {
            satisfaction: Number(document.getElementById("score-satisfaction").value),
            stability: Number(document.getElementById("score-stability").value),
            growth: Number(document.getElementById("score-growth").value),
            freedom: Number(document.getElementById("score-freedom").value),
            relationship: Number(document.getElementById("score-relationship").value)
        };
    }

    function setScoreUI(scores) {
        document.getElementById("score-satisfaction").value = scores.satisfaction;
        document.getElementById("score-stability").value = scores.stability;
        document.getElementById("score-growth").value = scores.growth;
        document.getElementById("score-freedom").value = scores.freedom;
        document.getElementById("score-relationship").value = scores.relationship;

        document.getElementById("score-satisfaction-val").innerText = scores.satisfaction;
        document.getElementById("score-stability-val").innerText = scores.stability;
        document.getElementById("score-growth-val").innerText = scores.growth;
        document.getElementById("score-freedom-val").innerText = scores.freedom;
        document.getElementById("score-relationship-val").innerText = scores.relationship;
    }

    function attachScoreSlider(idSlider, idVal) {
        const slider = document.getElementById(idSlider);
        const val = document.getElementById(idVal);
        slider.addEventListener("input", function () {
            val.innerText = slider.value;
        });
    }

    attachScoreSlider("score-satisfaction", "score-satisfaction-val");
    attachScoreSlider("score-stability", "score-stability-val");
    attachScoreSlider("score-growth", "score-growth-val");
    attachScoreSlider("score-freedom", "score-freedom-val");
    attachScoreSlider("score-relationship", "score-relationship-val");

    function renderHistory() {
        const list = document.getElementById("history-list");
        list.innerHTML = "";
        state.runs.forEach(function (run, index) {
            const item = document.createElement("div");
            item.className = "history-item" + (run.id === state.currentRunId ? " active" : "");
            item.dataset.id = run.id;

            const meta = document.createElement("div");
            meta.className = "history-meta";

            const title = document.createElement("div");
            title.className = "history-title";
            title.innerText = run.title;

            const sub = document.createElement("div");
            sub.className = "history-sub";
            sub.innerText = formatTime(run.timestamp) + " Â· " + run.modeText;

            meta.appendChild(title);
            meta.appendChild(sub);

            const badge = document.createElement("div");
            badge.className = "history-badge";
            badge.innerText = "è¯„åˆ†å·²" + (run.scores ? "ä¿å­˜" : "æœªä¿å­˜");

            item.appendChild(meta);
            item.appendChild(badge);

            item.addEventListener("click", function () {
                switchToRun(run.id);
            });

            list.appendChild(item);
        });
    }

    function switchToRun(id) {
        const run = state.runs.find(function (r) { return r.id === id; });
        if (!run) return;
        state.currentRunId = id;

        document.getElementById("output-wrapper").style.display = "block";
        document.getElementById("output-text").innerText = run.resultText;
        document.getElementById("output-title").innerText = run.title;
        document.getElementById("output-tag").innerText = run.modeText + " æ¨¡å¼";
        document.getElementById("current-run-label").innerText = "å½“å‰ï¼š" + run.title;

        if (run.scores) {
            setScoreUI(run.scores);
        }

        renderHistory();
    }

    function updateRadarChart() {
        const labels = ["æ•´ä½“æ»¡æ„åº¦", "ç¨³å®šæ€§", "æˆé•¿æ€§", "è‡ªç”±åº¦", "å…³ç³»è´¨é‡"];
        const datasets = [];
        const colors = [
            "rgba(56, 189, 248, 0.7)",
            "rgba(129, 140, 248, 0.7)",
            "rgba(52, 211, 153, 0.7)",
            "rgba(251, 191, 36, 0.7)",
            "rgba(248, 113, 113, 0.7)"
        ];

        const legendContainer = document.getElementById("chart-legend");
        legendContainer.innerHTML = "";

        let colorIndex = 0;
        state.runs.forEach(function (run) {
            if (!run.scores) return;
            const c = colors[colorIndex % colors.length];
            datasets.push({
                label: run.title,
                data: [
                    run.scores.satisfaction,
                    run.scores.stability,
                    run.scores.growth,
                    run.scores.freedom,
                    run.scores.relationship
                ],
                fill: true,
                backgroundColor: c.replace("0.7", "0.18"),
                borderColor: c,
                pointBackgroundColor: c,
                pointBorderColor: "#0b1120",
                pointRadius: 3
            });

            const legendItem = document.createElement("div");
            legendItem.className = "legend-item";
            const colorDot = document.createElement("div");
            colorDot.className = "legend-color";
            colorDot.style.backgroundColor = c;
            const text = document.createElement("span");
            text.innerText = run.title;
            legendItem.appendChild(colorDot);
            legendItem.appendChild(text);
            legendContainer.appendChild(legendItem);

            colorIndex++;
        });

        const ctx = document.getElementById("radarChart").getContext("2d");
        if (state.radarChart) {
            state.radarChart.destroy();
        }

        state.radarChart = new Chart(ctx, {
            type: "radar",
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        angleLines: { color: "rgba(148, 163, 184, 0.4)" },
                        grid: { color: "rgba(55, 65, 81, 0.8)" },
                        suggestedMin: 0,
                        suggestedMax: 10,
                        ticks: {
                            display: true,
                            stepSize: 2,
                            color: "rgba(148, 163, 184, 0.9)",
                            backdropColor: "transparent"
                        },
                        pointLabels: {
                            color: "rgba(209, 213, 219, 0.9)",
                            font: { size: 11 }
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    document.getElementById("btn-save-score").addEventListener("click", function () {
        if (!state.currentRunId) return;
        const run = state.runs.find(function (r) { return r.id === state.currentRunId; });
        if (!run) return;
        run.scores = getCurrentScoresFromUI();
        renderHistory();
        updateRadarChart();
        document.getElementById("chart-hint").innerText = "å·²æ›´æ–° Â· ä½ å¯ä»¥å¯¹æ¯”ä¸åŒæ¨¡æ‹Ÿçš„é›·è¾¾å›¾å½¢çŠ¶";
    });

    document.getElementById("btn-generate").addEventListener("click", async function () {
        const background = document.getElementById("field-background").value.trim();
        const basic = document.getElementById("field-basic").value.trim();
        const timeline = document.getElementById("field-timeline").value.trim();
        const target = document.getElementById("field-target").value.trim();
        const skills = document.getElementById("field-skills").value.trim();
        const mode = document.getElementById("field-mode").value;

        if (!background || !basic || !timeline || !target) {
            alert("è¯·è‡³å°‘å®Œæ•´å¡«å†™å‰å››ä¸ªå­—æ®µï¼šä¸ªäººèƒŒæ™¯ / å¹´é¾„å­¦å†åŸå¸‚ / æ—¶é—´çº¿ / æƒ³å›åˆ°çš„æ—¶é—´ç‚¹ã€‚");
            return;
        }

        const loading = document.getElementById("loading");
        loading.style.display = "flex";

        try {
            const payload = {
                background: background,
                basic: basic,
                timeline: timeline,
                target: target,
                skills: skills,
                mode: mode,
                lang: "zh"
            };

            const res = await fetch("/api/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            const text = data.result || JSON.stringify(data, null, 2);

            const runId = Date.now().toString();
            const index = state.runs.length;
            const title = createRunTitle(index, mode);
            const modeText = mode === "abc" ? "A/B/C" : (mode === "single" ? "å•è·¯çº¿" : "å¯¹è¯");

            const run = {
                id: runId,
                title: title,
                mode: mode,
                modeText: modeText,
                timestamp: Date.now(),
                resultText: text,
                scores: null
            };

            state.runs.push(run);
            if (state.runs.length > 10) {
                state.runs.shift();
            }

            state.currentRunId = runId;
            document.getElementById("output-wrapper").style.display = "block";
            document.getElementById("output-text").innerText = text;
            document.getElementById("output-title").innerText = title;
            document.getElementById("output-tag").innerText = modeText + " æ¨¡å¼";
            document.getElementById("current-run-label").innerText = "å½“å‰ï¼š" + title;

            renderHistory();
        } catch (e) {
            alert("ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š" + e.message);
        } finally {
            loading.style.display = "none";
        }
    });

    document.getElementById("btn-clear").addEventListener("click", function () {
        document.getElementById("output-wrapper").style.display = "none";
        document.getElementById("current-run-label").innerText = "å°šæœªç”Ÿæˆ";
    });

    document.getElementById("btn-copy").addEventListener("click", function () {
        const text = document.getElementById("output-text").innerText;
        if (!text) return;
        navigator.clipboard.writeText(text);
        document.getElementById("chart-hint").innerText = "å·²å¤åˆ¶å½“å‰ç»“æœåˆ°å‰ªè´´æ¿";
    });

    document.getElementById("btn-open-window").addEventListener("click", function () {
        const text = document.getElementById("output-text").innerText;
        if (!text) return;
        const w = window.open("", "_blank");
        w.document.open();
        w.document.write("<pre style='white-space:pre-wrap;font-family:system-ui,Segoe UI,Arial,sans-serif;font-size:13px;padding:16px;background:#020617;color:#e5e7eb;'>" +
            text.replace(/</g, "&lt;").replace(/>/g, "&gt;") +
            "</pre>");
        w.document.close();
    });

    document.getElementById("btn-export").addEventListener("click", function () {
        const text = document.getElementById("output-text").innerText;
        if (!text) {
            alert("å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœã€‚");
            return;
        }
        const jsPDFLib = window.jspdf;
        if (!jsPDFLib) {
            alert("PDF æ¨¡å—å°šæœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•ã€‚");
            return;
        }
        const pdf = new jsPDFLib.jsPDF({ unit: "pt", format: "a4" });
        const lines = pdf.splitTextToSize(text, 500);
        pdf.text(lines, 50, 50);
        pdf.save("relife_result.pdf");
    });

    window.onload = function () {
        document.getElementById("chart-hint").innerText = "ç”Ÿæˆæ¨¡æ‹Ÿå¹¶ä¿å­˜è¯„åˆ†åï¼Œè¿™é‡Œä¼šå‡ºç°å¯¹æ¯”é›·è¾¾å›¾";
    };
</script>

</body>
</html>
