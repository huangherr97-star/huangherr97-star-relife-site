<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RE:LIFE | 因果重塑终端</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --bg: #030508;
        --card: #0A0F16;
        --text: #E4E4E7;
        --sub: #9CA3AF;
        --primary: #3B82F6;
        --danger: #EF4444;
        --border: #1E293B;
        --yellow: #FACC15;
    }

    body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        display: flex;
        justify-content: center;
        padding: 40px 20px;
    }

    .container {
        width: 100%;
        max-width: 650px;
        background: var(--card);
        border-radius: 28px;
        padding: 40px;
        border: 1px solid var(--border);
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    h1, h2 {
        font-weight: 200;
        margin-bottom: 25px;
    }

    .step {
        display: none;
        animation: fade 0.4s ease;
    }

    .active {
        display: block;
    }

    @keyframes fade {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .field {
        margin-bottom: 22px;
    }

    label {
        font-size: 12px;
        color: var(--sub);
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    input, select, textarea {
        width: 100%;
        margin-top: 8px;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #111827;
        color: var(--text);
        font-size: 15px;
        box-sizing: border-box;
    }

    textarea {
        resize: vertical;
    }

    .btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        background: var(--primary);
        color: white;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
        transition: 0.2s;
    }

    .btn:disabled {
        background: #1E293B;
        cursor: not-allowed;
    }

    .nav-btns {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
    }

    .small-btn {
        padding: 12px 20px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #111827;
        color: var(--text);
        cursor: pointer;
    }

    #output {
        margin-top: 30px;
        padding: 20px;
        border: 1px dashed var(--border);
        border-radius: 12px;
        display: none;
        line-height: 1.6;
        font-size: 15px;
        background: rgba(255,255,255,0.02);
    }

    .chart-block {
        margin-top: 30px;
        padding: 20px;
        background: rgba(255,255,255,0.03);
        border-radius: 16px;
        border: 1px solid var(--border);
    }

    .bar-container {
        margin-top: 20px;
    }

    .bar-label {
        font-size: 13px;
        color: var(--sub);
        margin-bottom: 6px;
    }

    .bar-bg {
        width: 100%;
        height: 10px;
        background: #1F2937;
        border-radius: 6px;
        overflow: hidden;
    }

    .bar-fill {
        height: 10px;
        border-radius: 6px;
    }

    .gravity-bar {
        height: 12px;
        background: #1F2937;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 10px;
    }

    .gravity-fill {
        height: 12px;
        background: var(--yellow);
        border-radius: 6px;
    }

</style>
</head>

<body>

<div class="container">

    <!-- STEP 1 -->
    <div class="step active" id="step1">
        <h2>Step 1 · 物理锚点</h2>

        <div class="field">
            <label>姓名</label>
            <input id="name">
        </div>

        <div class="field">
            <label>性别</label>
            <select id="gender">
                <option value="">请选择</option>
                <option>男</option>
                <option>女</option>
                <option>其他</option>
            </select>
        </div>

        <div class="field">
            <label>出生年月</label>
            <input id="birth" placeholder="1997-08">
        </div>

        <div class="field">
            <label>目前所在地</label>
            <input id="location">
        </div>

        <div class="field">
            <label>最高学历</label>
            <input id="edu">
        </div>

        <button class="btn" onclick="nextStep(2)">继续</button>
    </div>

    <!-- STEP 2 -->
    <div class="step" id="step2">
        <h2>Step 2 · 现实画像</h2>

        <div class="field">
            <label>籍贯</label>
            <input id="origin">
        </div>

        <div class="field">
            <label>核心性格</label>
            <input id="personality">
        </div>

        <div class="field">
            <label>当前职业与职位</label>
            <input id="career">
        </div>

        <div class="nav-btns">
            <button class="small-btn" onclick="nextStep(1)">上一步</button>
            <button class="small-btn" onclick="nextStep(3)">继续</button>
        </div>
    </div>

    <!-- STEP 3 -->
    <div class="step" id="step3">
        <h2>Step 3 · 灵魂长轴</h2>

        <div class="field">
            <label>你的长期经历、心理压力、隐秘想法</label>
            <textarea id="longtext" rows="5"></textarea>
        </div>

        <div class="nav-btns">
            <button class="small-btn" onclick="nextStep(2)">上一步</button>
            <button class="small-btn" onclick="nextStep(4)">继续</button>
        </div>
    </div>

    <!-- STEP 4 -->
    <div class="step" id="step4">
        <h2>Step 4 · 回溯点与干预</h2>

        <div class="field">
            <label>回溯时间点</label>
            <input id="rewind" placeholder="如：2018-06-12 14:00">
        </div>

        <div class="field">
            <label>你希望做出的改变</label>
            <textarea id="change" rows="3"></textarea>
        </div>

        <div class="field">
            <label>特殊能力（陷阱）</label>
            <select id="ability">
                <option>无能力</option>
                <option>预知未来</option>
                <option>读心术</option>
                <option>无限财富</option>
                <option>绝对掌控</option>
            </select>
        </div>

        <button class="btn" onclick="submitAll()">提交因果推演</button>

        <div class="nav-btns">
            <button class="small-btn" onclick="nextStep(3)">上一步</button>
        </div>
    </div>

    <!-- OUTPUT -->
    <div id="output"></div>

</div>

<script>
function nextStep(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + n).classList.add('active');
}

let radarChart;

async function submitAll() {
    const out = document.getElementById('output');
    out.style.display = 'block';
    out.innerHTML = "正在构建因果链路…";

    const payload = {
        name: document.getElementById('name').value,
        current_status: `
性别：${document.getElementById('gender').value}
出生：${document.getElementById('birth').value}
所在地：${document.getElementById('location').value}
学历：${document.getElementById('edu').value}
职业：${document.getElementById('career').value}
性格：${document.getElementById('personality').value}
籍贯：${document.getElementById('origin').value}
        `,
        history_context: document.getElementById('longtext').value,
        user_intervention: `
回溯点：${document.getElementById('rewind').value}
改变：${document.getElementById('change').value}
        `,
        ability: document.getElementById('ability').value
    };

    try {
        const res = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        renderFinal(data);

    } catch (e) {
        out.innerHTML = "推演失败，请检查网络或稍后再试。";
    }
}

function renderFinal(data) {
    const out = document.getElementById('output');

    out.innerHTML = `
        <h2>终局判定</h2>
        <p>${data.verdict_text}</p>

        <div class="chart-block">
            <canvas id="radarChart"></canvas>
        </div>

        <div class="bar-container">
            <div class="bar-label">现实 vs 预期</div>
            <div class="bar-bg">
                <div class="bar-fill" style="width:${data.compare.reality}%; background:var(--danger);"></div>
            </div>
            <div class="bar-bg" style="margin-top:6px;">
                <div class="bar-fill" style="width:${data.compare.expected}%; background:#6B7280;"></div>
            </div>
        </div>

        <div style="margin-top:25px;">
            <div class="bar-label">Character Gravity（真实度冲突）</div>
            <div class="gravity-bar">
                <div class="gravity-fill" style="width:${data.gravity}%;"></div>
            </div>
        </div>
    `;

    const ctx = document.getElementById('radarChart');

    if (radarChart) radarChart.destroy();

    radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['逻辑一致性', '性格真实度', '情绪稳定性', '资源匹配度', '事件可行性'],
            datasets: [{
                label: '评分',
                data: [
                    data.scores.logic,
                    data.scores.character,
                    data.scores.emotion,
                    data.scores.resource,
                    data.scores.feasibility
                ],
                backgroundColor: 'rgba(59,130,246,0.2)',
                borderColor: 'rgba(59,130,246,1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(59,130,246,1)'
            }]
        },
        options: {
            scales: {
                r: {
                    angleLines: { color: '#1E293B' },
                    grid: { color: '#1E293B' },
                    pointLabels: { color: '#E4E4E7' },
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            },
            plugins: { legend: { display: false } }
        }
    });
}
</script>

</body>
</html>
