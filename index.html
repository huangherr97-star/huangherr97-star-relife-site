<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RE:LIFE | 回环</title>
  <style>
    :root{
      --bg:#0B1220; --card:#0F1A2E; --card2:#0D1628;
      --text:#E6EDF7; --muted:#9FB0CC;
      --primary:#4C6FFF; --accent:#22D3EE; --warn:#F59E0B; --danger:#FF5A5F;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", Arial;
      background: radial-gradient(1200px 700px at 50% -10%, rgba(76,111,255,.35), transparent 60%),
                  radial-gradient(900px 500px at 85% 10%, rgba(34,211,238,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 1200px; margin: 42px auto; padding: 0 18px; }
    .title{
      text-align:center; margin-bottom: 18px;
    }
    .title h1{ margin:0; font-size: 44px; letter-spacing:1px; }
    .title p{ margin:10px 0 0; color:var(--muted); }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 18px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .hd .h{
      font-size: 18px; font-weight: 700;
    }
    .pill{
      font-size:12px; color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(0,0,0,.15);
      user-select:none;
    }
    .bd{ padding: 16px 18px; }
    label{
      display:block; font-size: 13px; color: var(--muted);
      margin: 10px 0 6px;
    }
    input, textarea, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
    }
    textarea{ min-height: 120px; resize: vertical; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 560px){ .row{ grid-template-columns:1fr; } }

    .btns{ display:flex; gap: 10px; margin-top: 12px; flex-wrap:wrap; }
    button{
      border: 0;
      border-radius: 12px;
      padding: 11px 14px;
      font-weight: 700;
      cursor:pointer;
      color: #0b1220;
      background: rgba(255,255,255,.85);
    }
    button.primary{
      background: linear-gradient(90deg, var(--primary), rgba(76,111,255,.75));
      color:white;
    }
    button.ghost{
      background: rgba(255,255,255,.08);
      color: var(--text);
      border: 1px solid var(--border);
    }
    button.warn{
      background: rgba(245,158,11,.18);
      color: #FFD7A6;
      border: 1px solid rgba(245,158,11,.35);
    }
    button:disabled{
      opacity:.55; cursor:not-allowed;
    }

    .status{
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .status .err{ color: #FFB4B4; }
    .status .ok{ color: #B7F7D0; }
    .box{
      background: rgba(0,0,0,.22);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      min-height: 260px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.7;
    }
    .tools{ display:flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .foot{
      margin-top: 18px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
      opacity:.9;
    }
    .tiny{ font-size:12px; color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .chat{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .chatlog{
      min-height: 190px;
      max-height: 300px;
      overflow:auto;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      line-height: 1.65;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .chatbar{
      display:flex;
      gap: 8px;
      align-items: stretch;
    }
    .chatbar input{
      flex:1;
      padding: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>RE:LIFE | 回环</h1>
      <p>理性人生模拟 · 非算命 · 非保证</p>
    </div>

    <div class="grid">
      <!-- 左：输入 -->
      <div class="card">
        <div class="hd">
          <div class="h">你的信息</div>
          <div class="pill mono" id="apiPill">API: /api/generate</div>
        </div>
        <div class="bd">
          <label>个人背景（必填）</label>
          <input id="background" placeholder="例如：28岁，工作3年，一事无成 / 或你自己的真实情况" />

          <label>人生经历时间线（必填，越具体越好）</label>
          <textarea id="timeline" placeholder="按时间写：\n- 18岁：...\n- 22岁：...\n- 26岁：...\n（越具体越好）"></textarea>

          <div class="row">
            <div>
              <label>想回到的时间点（必填）</label>
              <input id="target" placeholder="例如：18岁高考 / 22岁毕业 / 某年某月" />
            </div>
            <div>
              <label>生成模式</label>
              <select id="mode">
                <option value="abc" selected>对比 A/B/C（推荐）</option>
                <option value="single">单一路线（更简洁）</option>
              </select>
            </div>
          </div>

          <label>能力 / 资源（可选）</label>
          <input id="resources" placeholder="例如：英语不错 / 家里支持 / 有一笔存款 / 记忆力强..." />

          <div class="btns">
            <button class="primary" id="btnRun">开始模拟</button>
            <button class="ghost" id="btnShare">生成分享链接</button>
            <button class="warn" id="btnClear">清空</button>
          </div>

          <div class="status" id="status">
            状态：就绪
            <div class="tiny">提示：如果返回 <span class="mono">HTTP 400 Missing required fields</span>，说明请求体缺少 background / timeline / target，本页会自动校验并提示缺哪项。</div>
          </div>
        </div>
      </div>

      <!-- 右：结果 + 对话 -->
      <div class="card">
        <div class="hd">
          <div class="h">结果</div>
          <div class="pill mono" id="pingPill">/api/ping</div>
        </div>
        <div class="bd split">
          <div class="box" id="resultBox">（点击“开始模拟”后，这里会出现生成内容）</div>

          <div class="tools">
            <button class="ghost" id="btnExpand">全部展开</button>
            <button class="ghost" id="btnCollapse">全部折叠</button>
            <button class="ghost" id="btnCopy">复制全部</button>
            <button class="ghost" id="btnPing">测试 API（/api/ping）</button>
          </div>

          <div class="chat">
            <div class="tiny">对话模式（可选）：基于你刚刚的输入 + 结果继续追问。不会算命，只做理性推演。</div>
            <div class="chatlog" id="chatLog">（对话记录保存在浏览器本地 localStorage）</div>
            <div class="chatbar">
              <input id="chatInput" placeholder="例如：我更适合继续读书吗？最小风险方案是什么？" />
              <button class="primary" id="btnSend">发送</button>
              <button class="ghost" id="btnChatClear">清空对话</button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="foot">
      RE:LIFE 提供的是基于用户输入的情景推演与理性分析，不构成现实建议、预测或保证。你对自己的选择负责。
    </div>
  </div>

<script>
  // ========= 工具 =========
  const $ = (id) => document.getElementById(id);

  function setStatus(text, type){
    const el = $("status");
    const tag = type === "err" ? "err" : type === "ok" ? "ok" : "";
    el.innerHTML = "状态：<span class='"+tag+"'>" + escapeHtml(text) + "</span>";
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function nowISO(){
    const d = new Date();
    return d.toISOString().replace("T"," ").slice(0,19);
  }

  function saveFormToUrl(){
    const data = getForm();
    const q = new URLSearchParams();
    q.set("background", data.background);
    q.set("timeline", data.timeline);
    q.set("target", data.target);
    q.set("resources", data.resources || "");
    q.set("mode", data.mode || "abc");
    const url = location.origin + location.pathname + "?" + q.toString();
    navigator.clipboard?.writeText(url);
    setStatus("已复制分享链接到剪贴板", "ok");
  }

  function loadFormFromUrl(){
    const q = new URLSearchParams(location.search);
    const bg = q.get("background");
    const tl = q.get("timeline");
    const tg = q.get("target");
    if(bg) $("background").value = bg;
    if(tl) $("timeline").value = tl;
    if(tg) $("target").value = tg;
    const rs = q.get("resources");
    if(rs !== null) $("resources").value = rs;
    const mode = q.get("mode");
    if(mode) $("mode").value = mode;
  }

  function getForm(){
    return {
      background: $("background").value.trim(),
      timeline: $("timeline").value.trim(),
      target: $("target").value.trim(),
      resources: $("resources").value.trim(),
      mode: $("mode").value
    };
  }

  function validateForm(data){
    const miss = [];
    if(!data.background) miss.push("background");
    if(!data.timeline) miss.push("timeline");
    if(!data.target) miss.push("target");
    return miss;
  }

  function renderResult(text){
    $("resultBox").textContent = text || "（空）";
  }

  function copyResult(){
    const txt = $("resultBox").textContent || "";
    navigator.clipboard?.writeText(txt);
    setStatus("已复制结果到剪贴板", "ok");
  }

  // 简单“展开/折叠”演示：不再做危险正则解析（你之前的正则就是这里炸的）
  function expandAll(){
    $("resultBox").style.maxHeight = "none";
    setStatus("已展开", "ok");
  }
  function collapseAll(){
    $("resultBox").style.maxHeight = "260px";
    $("resultBox").style.overflow = "auto";
    setStatus("已折叠（滚动查看）", "ok");
  }

  // ========= API 调用 =========
  async function postJSON(url, body, timeoutMs=90000){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
        signal: ctrl.signal
      });

      const ct = res.headers.get("content-type") || "";
      let dataText = "";
      let dataJson = null;

      if(ct.includes("application/json")){
        dataJson = await res.json().catch(()=>null);
      }else{
        dataText = await res.text().catch(()=> "");
      }

      if(!res.ok){
        const msg = dataJson ? JSON.stringify(dataJson) : dataText || (res.status + " " + res.statusText);
        const err = new Error(msg);
        err.status = res.status;
        err.payload = dataJson || dataText;
        throw err;
      }
      return dataJson ?? { ok:true, text:dataText };
    }finally{
      clearTimeout(t);
    }
  }

  async function getText(url, timeoutMs=15000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, { method:"GET", signal: ctrl.signal });
      const txt = await res.text().catch(()=> "");
      return { ok: res.ok, status: res.status, text: txt };
    }finally{ clearTimeout(t); }
  }

  // ========= 业务：生成 =========
  async function runGenerate(){
    const data = getForm();
    const miss = validateForm(data);
    if(miss.length){
      setStatus("缺少必填字段：" + miss.join(", "), "err");
      return;
    }

    renderResult("⏳ 正在生成...\n（如果 10-30 秒无返回，请看右上角 Vercel Function Logs）");
    setStatus("请求中...", "");

    const body = {
      background: data.background,
      timeline: data.timeline,
      target: data.target,
      resources: data.resources,
      mode: data.mode
    };

    try{
      const out = await postJSON("/api/generate", body, 90000);
      if(out && out.text){
        renderResult(out.text);
      }else{
        renderResult(JSON.stringify(out, null, 2));
      }
      setStatus("生成完成 " + nowISO(), "ok");
      // 把最后一次结果给对话用
      localStorage.setItem("relife:lastResult", $("resultBox").textContent || "");
    }catch(e){
      const status = e.status ? ("HTTP " + e.status + "：") : "";
      renderResult(status + (e.message || "请求失败"));
      setStatus("生成失败（看结果框错误）", "err");
      console.error(e);
    }
  }

  // ========= 对话：继续追问 =========
  function loadChat(){
    const raw = localStorage.getItem("relife:chat") || "";
    $("chatLog").textContent = raw || "（对话记录保存在浏览器本地 localStorage）";
  }
  function appendChatLine(line){
    const raw = localStorage.getItem("relife:chat") || "";
    const next = (raw ? raw + "\n" : "") + line;
    localStorage.setItem("relife:chat", next);
    $("chatLog").textContent = next;
    $("chatLog").scrollTop = $("chatLog").scrollHeight;
  }

  async function sendChat(){
    const q = $("chatInput").value.trim();
    if(!q) return;

    const data = getForm();
    const miss = validateForm(data);
    if(miss.length){
      setStatus("对话前先补齐必填字段：" + miss.join(", "), "err");
      return;
    }

    const lastResult = localStorage.getItem("relife:lastResult") || "";
    appendChatLine("你：" + q);

    setStatus("对话请求中...", "");
    $("chatInput").value = "";

    const body = {
      background: data.background,
      timeline: data.timeline,
      target: data.target,
      resources: data.resources,
      mode: "chat",
      question: q,
      lastResult
    };

    try{
      const out = await postJSON("/api/generate", body, 90000);
      const ans = out && out.text ? out.text : JSON.stringify(out);
      appendChatLine("RE:LIFE：" + ans);
      setStatus("对话完成 " + nowISO(), "ok");
    }catch(e){
      appendChatLine("（错误）" + (e.status ? "HTTP "+e.status+" " : "") + (e.message || "请求失败"));
      setStatus("对话失败（看对话框错误）", "err");
      console.error(e);
    }
  }

  async function ping(){
    setStatus("测试 /api/ping ...", "");
    const r = await getText("/api/ping");
    if(r.ok){
      setStatus("Ping OK（" + r.status + "）", "ok");
    }else{
      setStatus("Ping 失败（" + r.status + "）", "err");
    }
    // 直接显示到结果框方便你看
    renderResult("GET /api/ping -> " + r.status + "\n\n" + r.text);
  }

  // ========= 绑定 =========
  $("btnRun").addEventListener("click", runGenerate);
  $("btnShare").addEventListener("click", saveFormToUrl);
  $("btnClear").addEventListener("click", ()=>{
    $("background").value = "";
    $("timeline").value = "";
    $("target").value = "";
    $("resources").value = "";
    $("mode").value = "abc";
    renderResult("（已清空）");
    setStatus("已清空", "ok");
  });

  $("btnCopy").addEventListener("click", copyResult);
  $("btnExpand").addEventListener("click", expandAll);
  $("btnCollapse").addEventListener("click", collapseAll);
  $("btnPing").addEventListener("click", ping);

  $("btnSend").addEventListener("click", sendChat);
  $("chatInput").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") sendChat();
  });
  $("btnChatClear").addEventListener("click", ()=>{
    localStorage.removeItem("relife:chat");
    loadChat();
    setStatus("已清空对话", "ok");
  });

  // 初始化
  loadFormFromUrl();
  loadChat();
</script>
</body>
</html>
