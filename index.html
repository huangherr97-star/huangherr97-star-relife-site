<!doctype html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RE:LIFE | 回环</title>

  <!-- jsPDF CDN，用于生成精美 PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0B1220;--card:#0f1a33cc;--line:#22304f;--text:#e8eefc;--muted:#9fb0d5;
      --primary:#4C6FFF;--primary2:#22D3EE;--warn:#F59E0B;
      --card-soft:rgba(255,255,255,.06);
    }
    :root[data-theme="light"]{
      --bg:#f3f4f6;--card:#ffffff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
      --primary:#2563eb;--primary2:#0ea5e9;--warn:#d97706;
      --card-soft:rgba(15,23,42,.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .title{display:flex;align-items:flex-end;gap:12px;margin-bottom:22px}
    .title h1{font-size:42px;letter-spacing:.5px;margin:0}
    .title .sub{color:var(--muted);font-size:14px;margin-bottom:6px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, var(--card-soft), var(--card-soft));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
      overflow:hidden;
    }
    :root[data-theme="light"] .card{
      border:1px solid #e5e7eb;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .card .hd{padding:18px 18px 10px;border-bottom:1px solid rgba(255,255,255,.07)}
    :root[data-theme="light"] .card .hd{border-bottom:1px solid #e5e7eb;}
    .card .hd h2{margin:0;font-size:18px}
    .card .bd{padding:18px}
    label{display:block;color:var(--muted);font-size:13px;margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      background:rgba(10,16,28,.55);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
    }
    :root[data-theme="light"] input,
    :root[data-theme="light"] textarea,
    :root[data-theme="light"] select{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      border:0;cursor:pointer;border-radius:12px;
      padding:10px 14px;font-weight:600;color:#081022;
      background:linear-gradient(135deg,var(--primary), #5a7bff);
      font-size:14px;
    }
    button.secondary{
      color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }
    :root[data-theme="light"] button.secondary{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    button.danger{
      color:#fff;background:rgba(245, 89, 11, .18);
      border:1px solid rgba(245, 89, 11, .35);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--muted);font-size:12px
    }
    :root[data-theme="light"] .pill{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .status{margin-top:12px;color:var(--muted);font-size:13px}
    .out{
      white-space:pre-wrap;
      background:rgba(10,16,28,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px;
      min-height:220px;
      line-height:1.55;
    }
    :root[data-theme="light"] .out{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .foot{margin-top:18px;color:var(--muted);font-size:12px}

    /* 进度条 */
    .progress-wrap{
      margin-top:10px;
      height:6px;
      background:rgba(255,255,255,.06);
      border-radius:999px;
      overflow:hidden;
    }
    :root[data-theme="light"] .progress-wrap{
      background:#e5e7eb;
    }
    .progress-bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--primary),var(--primary2));
      transition:width .3s ease;
    }

    /* 主题切换小按钮 */
    .theme-toggle{
      margin-left:10px;
      font-size:12px;
      padding:6px 10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>RE:LIFE | 回环</h1>
      <div class="sub">理性人生模拟 · 非算命 · 非保证</div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <div class="pill">
          API: <span id="apiLabel" class="mono"></span>
        </div>
        <button class="secondary theme-toggle" id="btnTheme">切换主题</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd"><h2>你的信息</h2></div>
        <div class="bd">
          <label>个人背景（必填）</label>
          <input id="background" placeholder="例：28岁，工作3年，想转行/想创业…" />

          <label>人生经历时间线（必填，越具体越好）</label>
          <textarea id="timeline" placeholder="用要点写：学校/工作/关键事件/决策/资源/人脉…"></textarea>

          <div class="row">
            <div>
              <label>想回到的时间点（必填）</label>
              <input id="target" placeholder="例：18岁高考 / 22岁毕业 / 2020年某次决定" />
            </div>
            <div>
              <label>生成模式</label>
              <select id="mode">
                <option value="abc" selected>对比 A/B/C（推荐）</option>
                <option value="single">单一路线（更快）</option>
                <option value="chat">追问模式（对话）</option>
              </select>
            </div>
          </div>

          <label>能力 / 资源（可选）</label>
          <input id="resources" placeholder="例：英语一般/有存款2万/家人支持/擅长写作…" />

          <div class="btns">
            <button id="btnRun">开始模拟</button>
            <button class="secondary" id="btnPing">测试 API</button>
            <button class="secondary" id="btnCopy">复制结果</button>
            <button class="secondary" id="btnPDF">导出 PDF</button>
            <button class="secondary" id="btnShare">分享链接</button>
            <button class="danger" id="btnClear">清空输出</button>
          </div>

          <div class="progress-wrap">
            <div class="progress-bar" id="progressBar"></div>
          </div>

          <div class="status" id="status">状态：就绪</div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>结果</h2></div>
        <div class="bd">
          <div id="out" class="out">点击“开始模拟”生成内容。</div>
          <div class="foot">
            如果长时间无响应，可以先点“测试 API”确认 /api/ping 是否正常，再检查 OpenAI 配额。
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const { jsPDF } = window.jspdf;

  const API_BASE = (location.hostname === "resetlife.blog")
    ? "https://www.resetlife.blog"
    : "";

  document.getElementById("apiLabel").textContent = API_BASE ? (API_BASE + "/api") : "/api";

  const $ = (id)=>document.getElementById(id);
  const outEl = $("out");
  const statusEl = $("status");
  const progressBar = $("progressBar");

  function setStatus(s){ statusEl.textContent = "状态：" + s; }

  function setProgress(p){
    progressBar.style.width = Math.max(0, Math.min(100, p)) + "%";
  }

  function formatError(e){
    return [
      "❌ 请求失败",
      "",
      "错误信息：",
      String(e),
      "",
      "可能原因：",
      "- API 未命中 Vercel（先点“测试 API”）",
      "- 输入字段缺失",
      "- OpenAI 请求超时或限流",
      "- 网络问题",
      "",
      "建议：",
      "- 刷新页面重试",
      "- 检查 /api/ping 是否正常",
      "- 检查 OpenAI 账单与配额",
    ].join("\n");
  }

  async function postJSON(path, body, timeoutMs=90000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body),
        signal: ctrl.signal,
      });

      const ct = res.headers.get("content-type") || "";
      const text = await res.text();

      if (!ct.includes("application/json")) {
        const hint = [
          `HTTP ${res.status} ${res.statusText}`,
          `content-type: ${ct || "(none)"}`,
          `server: ${res.headers.get("server") || "(none)"}`,
          `x-vercel-id: ${res.headers.get("x-vercel-id") || "(none)"}`,
          "",
          text
        ].join("\n");
        throw new Error(hint);
      }

      const data = JSON.parse(text);
      if(!res.ok){
        throw new Error(`HTTP ${res.status}: ${JSON.stringify(data)}`);
      }
      return data;
    } finally {
      clearTimeout(t);
    }
  }

  async function getText(path, timeoutMs=15000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(path, { signal: ctrl.signal });
      const text = await res.text();
      return { res, text };
    } finally { clearTimeout(t); }
  }

  // 主题切换
  $("btnTheme").onclick = ()=>{
    const root = document.documentElement;
    const cur = root.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    root.setAttribute("data-theme", next);
    localStorage.setItem("relife-theme", next);
  };
  (function initTheme(){
    const saved = localStorage.getItem("relife-theme");
    if (saved) document.documentElement.setAttribute("data-theme", saved);
  })();

  // 清空
  $("btnClear").onclick = ()=>{ outEl.textContent = ""; setStatus("已清空"); setProgress(0); };

  // ping
  $("btnPing").onclick = async ()=>{
    setStatus("ping 中…");
    setProgress(20);
    try{
      const { res, text } = await getText(API_BASE + "/api/ping");
      outEl.textContent =
        `GET ${API_BASE}/api/ping\n` +
        `HTTP ${res.status}\n` +
        `server: ${res.headers.get("server") || "(none)"}\n` +
        `x-vercel-id: ${res.headers.get("x-vercel-id") || "(none)"}\n\n` +
        text;
      setStatus("ping 完成");
      setProgress(100);
      setTimeout(()=>setProgress(0), 800);
    }catch(e){
      outEl.textContent = formatError(e);
      setStatus("ping 失败");
      setProgress(0);
    }
  };

  // 复制结果
  $("btnCopy").onclick = async ()=>{
    const text = outEl.textContent.trim();
    if (!text) {
      alert("没有可复制的内容，请先生成结果。");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      setStatus("结果已复制到剪贴板");
    }catch(e){
      alert("复制失败：" + e);
    }
  };

  // 导出 PDF（精美排版）
  $("btnPDF").onclick = ()=>{
    const content = outEl.textContent.trim();
    if (!content) {
      alert("没有可导出的内容，请先生成结果。");
      return;
    }

    const doc = new jsPDF({
      unit: "pt",
      format: "a4",
    });

    const margin = 40;
    let y = 60;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("RE:LIFE 模拟结果分享", margin, y);
    y += 24;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(120);
    doc.text("生成时间：" + new Date().toLocaleString(), margin, y);
    y += 20;

    doc.setDrawColor(200);
    doc.line(margin, y, 595 - margin, y);
    y += 20;

    doc.setFontSize(12);
    doc.setTextColor(0);

    const inputBlock = [
      "【用户输入】",
      "背景：" + ($("background").value || "（未填写）"),
      "时间线：" + ($("timeline").value || "（未填写）"),
      "回到时间点：" + ($("target").value || "（未填写）"),
      "能力/资源：" + ($("resources").value || "（未填写）"),
      "模式：" + ($("mode").value || "（未选择）"),
      "",
      "【模拟结果】",
      content
    ].join("\n");

    const lines = doc.splitTextToSize(inputBlock, 595 - margin * 2);

    const pageHeight = doc.internal.pageSize.getHeight();
    for (let i = 0; i < lines.length; i++) {
      if (y > pageHeight - 60) {
        doc.addPage();
        y = 60;
      }
      doc.text(lines[i], margin, y);
      y += 16;
    }

    doc.save("RE_LIFE_模拟结果.pdf");
    setStatus("PDF 已导出");
  };

  // 分享链接（URL 参数自动填充）
  $("btnShare").onclick = ()=>{
    const params = new URLSearchParams({
      background: $("background").value,
      timeline: $("timeline").value,
      target: $("target").value,
      resources: $("resources").value,
      mode: $("mode").value,
    });
    const url = location.origin + location.pathname + "?" + params.toString();
    navigator.clipboard.writeText(url).then(()=>{
      setStatus("分享链接已复制");
      alert("分享链接已复制：\n" + url);
    }).catch(e=>{
      alert("复制失败：" + e);
    });
  };

  // 页面加载时，根据 URL 参数自动填充
  (function fillFromQuery(){
    const p = new URLSearchParams(location.search);
    if (p.get("background")) $("background").value = p.get("background");
    if (p.get("timeline")) $("timeline").value = p.get("timeline");
    if (p.get("target")) $("target").value = p.get("target");
    if (p.get("resources")) $("resources").value = p.get("resources");
    if (p.get("mode")) $("mode").value = p.get("mode");
  })();

  // 开始模拟（带进度条动画）
  $("btnRun").onclick = async ()=>{
    const background = $("background").value.trim();
    const timeline = $("timeline").value.trim();
    const target = $("target").value.trim();
    const resources = $("resources").value.trim();
    const mode = $("mode").value;

    if(!background || !timeline || !target){
      outEl.textContent = "请把：个人背景 / 时间线 / 想回到的时间点 填完整（必填）。";
      setStatus("缺少必填项");
      setProgress(0);
      return;
    }

    setStatus("请求中…");
    setProgress(10);
    outEl.textContent = "⏳ 正在生成…（通常 10~30 秒，如长时间无响应可先测试 API）";

    try{
      // 进度条假装推进
      let fake = 10;
      const timer = setInterval(()=>{
        fake = Math.min(fake + 5, 85);
        setProgress(fake);
      }, 800);

      const data = await postJSON(API_BASE + "/api/generate", {
        background, timeline, target, resources, mode
      }, 120000);

      clearInterval(timer);
      setProgress(100);

      const text = data.text || data.content || JSON.stringify(data, null, 2);
      outEl.textContent = text;
      setStatus("完成");
      setTimeout(()=>setProgress(0), 1000);
    }catch(e){
      outEl.textContent = formatError(e);
      setStatus("失败（看输出细节）");
      setProgress(0);
    }
  };
</script>
</body>
</html>
