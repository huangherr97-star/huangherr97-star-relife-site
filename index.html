<!doctype html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RE:LIFE | å›ç¯</title>

  <!-- jsPDF ç”¨äºå¯¼å‡º PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0B1220;--card:#0f1a33cc;--line:#22304f;--text:#e8eefc;--muted:#9fb0d5;
      --primary:#4C6FFF;--primary2:#22D3EE;--warn:#F59E0B;
      --card-soft:rgba(255,255,255,.06);
    }
    :root[data-theme="light"]{
      --bg:#f3f4f6;--card:#ffffff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
      --primary:#2563eb;--primary2:#0ea5e9;--warn:#d97706;
      --card-soft:rgba(15,23,42,.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .title{display:flex;align-items:flex-end;gap:12px;margin-bottom:22px}
    .title h1{font-size:42px;letter-spacing:.5px;margin:0}
    .title .sub{color:var(--muted);font-size:14px;margin-bottom:6px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, var(--card-soft), var(--card-soft));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
      overflow:hidden;
    }
    :root[data-theme="light"] .card{
      border:1px solid #e5e7eb;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .card .hd{padding:18px 18px 10px;border-bottom:1px solid rgba(255,255,255,.07)}
    :root[data-theme="light"] .card .hd{border-bottom:1px solid #e5e7eb;}
    .card .hd h2{margin:0;font-size:18px}
    .card .bd{padding:18px}
    label{display:block;color:var(--muted);font-size:13px;margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      background:rgba(10,16,28,.55);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
    }
    :root[data-theme="light"] input,
    :root[data-theme="light"] textarea,
    :root[data-theme="light"] select{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      border:0;cursor:pointer;border-radius:12px;
      padding:10px 14px;font-weight:600;color:#081022;
      background:linear-gradient(135deg,var(--primary), #5a7bff);
      font-size:14px;
    }
    button.secondary{
      color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }
    :root[data-theme="light"] button.secondary{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    button.danger{
      color:#fff;background:rgba(245, 89, 11, .18);
      border:1px solid rgba(245, 89, 11, .35);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--muted);font-size:12px
    }
    :root[data-theme="light"] .pill{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .status{margin-top:12px;color:var(--muted);font-size:13px}
    .out{
      white-space:pre-wrap;
      background:rgba(10,16,28,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px;
      min-height:220px;
      line-height:1.55;
    }
    :root[data-theme="light"] .out{
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .foot{margin-top:18px;color:var(--muted);font-size:12px}

    .progress-wrap{
      margin-top:10px;
      height:6px;
      background:rgba(255,255,255,.06);
      border-radius:999px;
      overflow:hidden;
    }
    :root[data-theme="light"] .progress-wrap{
      background:#e5e7eb;
    }
    .progress-bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--primary),var(--primary2));
      transition:width .3s ease;
    }

    .theme-toggle{
      margin-left:10px;
      font-size:12px;
      padding:6px 10px;
    }

    .hint-short{
      margin-top:8px;
      font-size:12px;
      color:var(--warn);
    }

    /* è¯­è¨€é€‰æ‹©é®ç½© */
    #langMask{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    #langBox{
      background:#fff;
      color:#111;
      padding:30px;
      border-radius:16px;
      width:300px;
      text-align:center;
      box-shadow:0 10px 40px rgba(0,0,0,.3);
    }
    #langBox h2{margin:0 0 20px;font-size:20px;}
    #langBox button{
      width:100%;
      margin:8px 0;
      padding:12px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-size:16px;
      font-weight:600;
      background:#4C6FFF;
      color:#fff;
    }
  </style>
</head>
<body>

<!-- è¯­è¨€é€‰æ‹©é®ç½© -->
<div id="langMask">
  <div id="langBox">
    <h2>é€‰æ‹©è¯­è¨€ / Choose Language</h2>
    <button onclick="selectLang('zh')">ä¸­æ–‡</button>
    <button onclick="selectLang('en')">English</button>
  </div>
</div>
<!-- è¯­è¨€é€‰æ‹©é®ç½©ç»“æŸï¼Œä¸Šæ–¹å·²æœ‰ -->
<div class="wrap" id="app" style="display:none;">
  <div class="title">
    <h1 id="t_app_title">RE:LIFE | å›ç¯</h1>
    <div class="sub" id="t_app_sub">ç†æ€§äººç”Ÿæ¨¡æ‹Ÿ Â· éç®—å‘½ Â· éä¿è¯</div>

    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <div class="pill">
        API: <span id="apiLabel" class="mono"></span>
      </div>
      <button class="secondary theme-toggle" id="btnTheme">ğŸŒ—</button>
    </div>
  </div>

  <div class="grid">
    <!-- å·¦ä¾§è¾“å…¥å¡ç‰‡ -->
    <div class="card">
      <div class="hd"><h2 id="t_your_info">ä½ çš„ä¿¡æ¯</h2></div>
      <div class="bd">

        <label id="t_background_label">ä¸ªäººèƒŒæ™¯ï¼ˆå¿…å¡«ï¼‰</label>
        <input id="background" placeholder="ä¾‹ï¼š28å²ï¼Œå·¥ä½œ3å¹´ï¼Œæƒ³è½¬è¡Œ/æƒ³åˆ›ä¸šâ€¦" />

        <label id="t_timeline_label">äººç”Ÿç»å†æ—¶é—´çº¿ï¼ˆå¿…å¡«ï¼‰</label>
        <textarea id="timeline" placeholder="ç”¨è¦ç‚¹å†™ï¼šå­¦æ ¡/å·¥ä½œ/å…³é”®äº‹ä»¶/å†³ç­–/èµ„æº/äººè„‰â€¦"></textarea>

        <div class="row">
          <div>
            <label id="t_target_label">æƒ³å›åˆ°çš„æ—¶é—´ç‚¹ï¼ˆå¿…å¡«ï¼‰</label>
            <input id="target" placeholder="ä¾‹ï¼š18å²é«˜è€ƒ / 22å²æ¯•ä¸š / 2020å¹´æŸæ¬¡å†³å®š" />
          </div>
          <div>
            <label id="t_mode_label">ç”Ÿæˆæ¨¡å¼</label>
            <select id="mode">
              <option value="abc">å¯¹æ¯” A/B/Cï¼ˆæ¨èï¼‰</option>
              <option value="single">å•ä¸€è·¯çº¿ï¼ˆæ›´å¿«ï¼‰</option>
              <option value="chat">è¿½é—®æ¨¡å¼ï¼ˆå¯¹è¯ï¼‰</option>
            </select>
          </div>
        </div>

        <label id="t_resources_label">èƒ½åŠ› / èµ„æºï¼ˆå¯é€‰ï¼‰</label>
        <input id="resources" placeholder="ä¾‹ï¼šè‹±è¯­ä¸€èˆ¬/æœ‰å­˜æ¬¾2ä¸‡/å®¶äººæ”¯æŒ/æ“…é•¿å†™ä½œâ€¦" />

        <label id="t_language_label">è¯­è¨€ / Language</label>
        <select id="language">
          <option value="zh">ä¸­æ–‡</option>
          <option value="en">English</option>
        </select>

        <div class="btns">
          <button id="btnRun">å¼€å§‹æ¨¡æ‹Ÿ</button>
          <button class="secondary" id="btnPing">æµ‹è¯• API</button>
          <button class="secondary" id="btnCopy">å¤åˆ¶ç»“æœ</button>
          <button class="secondary" id="btnPDF">å¯¼å‡º PDF</button>
          <button class="secondary" id="btnShare">åˆ†äº«é“¾æ¥</button>
          <button class="danger" id="btnClear">æ¸…ç©ºè¾“å‡º</button>
        </div>

        <div class="progress-wrap">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="status" id="status">çŠ¶æ€ï¼šå°±ç»ª</div>

        <div class="hint-short" id="hintShort" style="display:none;">
          å»ºè®®è¡¥å……ä¿¡æ¯ï¼ˆè¿½é—®ï¼‰ï¼šå¯ä»¥å¤šå†™ä¸€äº›å…³é”®èŠ‚ç‚¹ã€è½¬æŠ˜ç‚¹ã€ä½ åœ¨æ„çš„ä¸œè¥¿ã€‚
        </div>

      </div>
    </div>

    <!-- å³ä¾§ç»“æœå¡ç‰‡ -->
    <div class="card">
      <div class="hd"><h2 id="t_result_title">ç»“æœ</h2></div>
      <div class="bd">
        <div id="out" class="out">ç‚¹å‡»â€œå¼€å§‹æ¨¡æ‹Ÿâ€ç”Ÿæˆå†…å®¹ã€‚</div>
        <div class="foot" id="t_result_hint">
          å¦‚æœé•¿æ—¶é—´æ— å“åº”ï¼Œå¯ä»¥å…ˆç‚¹â€œæµ‹è¯• APIâ€ç¡®è®¤ /api/ping æ˜¯å¦æ­£å¸¸ï¼Œå†æ£€æŸ¥ OpenAI é…é¢ã€‚
        </div>
      </div>
    </div>
  </div>
</div>
<script>
/* ---------------------------
   è¯­è¨€é€‰æ‹©ï¼ˆè¿›å…¥é¡µé¢ç¬¬ä¸€æ­¥ï¼‰
---------------------------- */
function selectLang(lang){
  localStorage.setItem("relife-lang", lang);
  document.getElementById("langMask").style.display = "none";
  document.getElementById("app").style.display = "block";
  applyLang(lang);
}

(function initLang(){
  const saved = localStorage.getItem("relife-lang");
  if(saved){
    document.getElementById("langMask").style.display = "none";
    document.getElementById("app").style.display = "block";
    applyLang(saved);
  }
})();

/* ---------------------------
   UI æ–‡æœ¬ï¼ˆä¸­è‹±æ–‡ï¼‰
---------------------------- */
const LANG = {
  zh:{
    app_title:"RE:LIFE | å›ç¯",
    app_sub:"ç†æ€§äººç”Ÿæ¨¡æ‹Ÿ Â· éç®—å‘½ Â· éä¿è¯",
    your_info:"ä½ çš„ä¿¡æ¯",
    background:"ä¸ªäººèƒŒæ™¯ï¼ˆå¿…å¡«ï¼‰",
    timeline:"äººç”Ÿç»å†æ—¶é—´çº¿ï¼ˆå¿…å¡«ï¼‰",
    target:"æƒ³å›åˆ°çš„æ—¶é—´ç‚¹ï¼ˆå¿…å¡«ï¼‰",
    mode:"ç”Ÿæˆæ¨¡å¼",
    resources:"èƒ½åŠ› / èµ„æºï¼ˆå¯é€‰ï¼‰",
    language:"è¯­è¨€ / Language",
    run:"å¼€å§‹æ¨¡æ‹Ÿ",
    ping:"æµ‹è¯• API",
    copy:"å¤åˆ¶ç»“æœ",
    pdf:"å¯¼å‡º PDF",
    share:"åˆ†äº«é“¾æ¥",
    clear:"æ¸…ç©ºè¾“å‡º",
    result:"ç»“æœ",
    result_hint:"å¦‚æœé•¿æ—¶é—´æ— å“åº”ï¼Œå¯ä»¥å…ˆç‚¹â€œæµ‹è¯• APIâ€ç¡®è®¤ /api/ping æ˜¯å¦æ­£å¸¸ï¼Œå†æ£€æŸ¥ OpenAI é…é¢ã€‚",
    short_hint:"å»ºè®®è¡¥å……ä¿¡æ¯ï¼ˆè¿½é—®ï¼‰ï¼šå¯ä»¥å¤šå†™ä¸€äº›å…³é”®èŠ‚ç‚¹ã€è½¬æŠ˜ç‚¹ã€ä½ åœ¨æ„çš„ä¸œè¥¿ã€‚",
    placeholder_bg:"ä¾‹ï¼š28å²ï¼Œå·¥ä½œ3å¹´ï¼Œæƒ³è½¬è¡Œ/æƒ³åˆ›ä¸šâ€¦",
    placeholder_tl:"ç”¨è¦ç‚¹å†™ï¼šå­¦æ ¡/å·¥ä½œ/å…³é”®äº‹ä»¶/å†³ç­–/èµ„æº/äººè„‰â€¦",
    placeholder_target:"ä¾‹ï¼š18å²é«˜è€ƒ / 22å²æ¯•ä¸š / 2020å¹´æŸæ¬¡å†³å®š"
  },
  en:{
    app_title:"RE:LIFE | Loop",
    app_sub:"Rational life simulation Â· No fortune telling Â· No guarantees",
    your_info:"Your Information",
    background:"Background (required)",
    timeline:"Life Timeline (required)",
    target:"Target Point (required)",
    mode:"Mode",
    resources:"Skills / Resources (optional)",
    language:"Language",
    run:"Run Simulation",
    ping:"Test API",
    copy:"Copy Result",
    pdf:"Export PDF",
    share:"Share Link",
    clear:"Clear Output",
    result:"Result",
    result_hint:"If it takes too long, test /api/ping first, then check OpenAI billing.",
    short_hint:"Suggested: add more details (key events, turning points, motivations).",
    placeholder_bg:"e.g. 28 years old, 3 years working, want to switch careerâ€¦",
    placeholder_tl:"List key events: school, jobs, decisions, resources, networkâ€¦",
    placeholder_target:"e.g. age 18 exam / age 22 graduation / 2020 decision"
  }
};

/* ---------------------------
   åº”ç”¨è¯­è¨€åˆ° UI
---------------------------- */
function applyLang(lang){
  const t = LANG[lang];

  document.getElementById("t_app_title").textContent = t.app_title;
  document.getElementById("t_app_sub").textContent = t.app_sub;

  document.getElementById("t_your_info").textContent = t.your_info;
  document.getElementById("t_background_label").textContent = t.background;
  document.getElementById("background").placeholder = t.placeholder_bg;

  document.getElementById("t_timeline_label").textContent = t.timeline;
  document.getElementById("timeline").placeholder = t.placeholder_tl;

  document.getElementById("t_target_label").textContent = t.target;
  document.getElementById("target").placeholder = t.placeholder_target;

  document.getElementById("t_mode_label").textContent = t.mode;
  document.getElementById("t_resources_label").textContent = t.resources;
  document.getElementById("t_language_label").textContent = t.language;

  document.getElementById("btnRun").textContent = t.run;
  document.getElementById("btnPing").textContent = t.ping;
  document.getElementById("btnCopy").textContent = t.copy;
  document.getElementById("btnPDF").textContent = t.pdf;
  document.getElementById("btnShare").textContent = t.share;
  document.getElementById("btnClear").textContent = t.clear;

  document.getElementById("t_result_title").textContent = t.result;
  document.getElementById("t_result_hint").textContent = t.result_hint;

  document.getElementById("hintShort").textContent = t.short_hint;
}

/* ---------------------------
   API BASE è‡ªåŠ¨åˆ¤æ–­
---------------------------- */
const API_BASE = (location.hostname === "resetlife.blog")
  ? "https://www.resetlife.blog"
  : "";

/* ---------------------------
   DOM å¿«æ·
---------------------------- */
const $ = id => document.getElementById(id);
const outEl = $("out");
const statusEl = $("status");
const progressBar = $("progressBar");
const hintShortEl = $("hintShort");

$("apiLabel").textContent = API_BASE ? API_BASE + "/api" : "/api";

/* ---------------------------
   çŠ¶æ€ & è¿›åº¦æ¡
---------------------------- */
function setStatus(s){ statusEl.textContent = s; }
function setProgress(p){ progressBar.style.width = p + "%"; }

/* ---------------------------
   é€šç”¨ POST JSON
---------------------------- */
async function postJSON(url, body){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 90000);

  try{
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body),
      signal: ctrl.signal
    });

    const text = await res.text();
    const ct = res.headers.get("content-type") || "";

    if(!ct.includes("application/json")){
      throw new Error("Non-JSON response:\n" + text);
    }

    const data = JSON.parse(text);
    if(!res.ok) throw new Error(JSON.stringify(data));

    return data;
  } finally {
    clearTimeout(t);
  }
}

/* ---------------------------
   æµ‹è¯• API
---------------------------- */
$("btnPing").onclick = async ()=>{
  setStatus("Testing...");
  setProgress(30);
  try{
    const r = await fetch(API_BASE + "/api/ping");
    const t = await r.text();
    outEl.textContent = t;
    setStatus("OK");
    setProgress(100);
    setTimeout(()=>setProgress(0),800);
  }catch(e){
    outEl.textContent = "Ping failed:\n" + e;
    setStatus("Failed");
    setProgress(0);
  }
};

/* ---------------------------
   å¤åˆ¶ç»“æœ
---------------------------- */
$("btnCopy").onclick = async ()=>{
  const text = outEl.textContent.trim();
  if(!text){ alert("æ— å†…å®¹"); return; }
  await navigator.clipboard.writeText(text);
  setStatus("å·²å¤åˆ¶");
};

/* ---------------------------
   åˆ†äº«é“¾æ¥
---------------------------- */
$("btnShare").onclick = ()=>{
  const params = new URLSearchParams({
    background:$("background").value,
    timeline:$("timeline").value,
    target:$("target").value,
    resources:$("resources").value,
    mode:$("mode").value,
    language:$("language").value
  });
  const url = location.origin + location.pathname + "?" + params.toString();
  navigator.clipboard.writeText(url);
  alert("å·²å¤åˆ¶åˆ†äº«é“¾æ¥ï¼š\n" + url);
};

/* ---------------------------
   PDF å¯¼å‡º
---------------------------- */
$("btnPDF").onclick = ()=>{
  const text = outEl.textContent.trim();
  if(!text){ alert("æ— å†…å®¹"); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  doc.text("RE:LIFE Result", 40, 40);
  const lines = doc.splitTextToSize(text, 520);
  doc.text(lines, 40, 80);

  doc.save("RE_LIFE.pdf");
};

/* ---------------------------
   æ¸…ç©º
---------------------------- */
$("btnClear").onclick = ()=>{
  outEl.textContent = "";
  setStatus("å·²æ¸…ç©º");
  setProgress(0);
  hintShortEl.style.display = "none";
};
/* ----------------------------------------------------
   æ–°çª—å£ï¼šå±•ç¤º A/B/C è·¯çº¿ + è¯„åˆ†è¡¨ + 30 å¤©è®¡åˆ’ + å¯¹è¯
----------------------------------------------------- */
function openResultWindow({ text, routes, followups, plan30d, context }) {
  const w = window.open("", "_blank");
  if (!w) {
    alert("æµè§ˆå™¨æ‹¦æˆªäº†æ–°çª—å£ï¼Œè¯·å…è®¸å¼¹çª—");
    return;
  }

  const lang = context.language === "en" ? "en" : "zh";

  const T = {
    zh:{
      title:"RE:LIFE æ¨¡æ‹Ÿç»“æœ",
      routes:"è·¯çº¿ A/B/C",
      scores:"è¯„åˆ†ç»´åº¦",
      plan:"30 å¤©è¡ŒåŠ¨è®¡åˆ’",
      chat:"è¿½é—®å¯¹è¯",
      ask:"æé—®",
      placeholder:"ä¾‹å¦‚ï¼šæˆ‘æ›´é€‚åˆ B å—ï¼Ÿæœ€å°é£é™©è·¯çº¿æ˜¯ä»€ä¹ˆï¼Ÿ",
      followups:"å»ºè®®è¿½é—®",
      ctx:"ä¸Šä¸‹æ–‡æ‘˜è¦"
    },
    en:{
      title:"RE:LIFE Result",
      routes:"Routes A/B/C",
      scores:"Scores",
      plan:"30-Day Plan",
      chat:"Follow-up Chat",
      ask:"Ask",
      placeholder:"e.g. Am I more suitable for route B?",
      followups:"Suggested follow-ups",
      ctx:"Context Summary"
    }
  }[lang];

  /* -------------------------
     æ–°çª—å£ HTML
  -------------------------- */
  const html = `
<!doctype html>
<html lang="${lang}">
<head>
<meta charset="utf-8" />
<title>${T.title}</title>
<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    background:#0b1120;
    color:#e5e7eb;
  }
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
  h1{font-size:28px;margin:0 0 16px;}
  h2{font-size:18px;margin:18px 0 8px;}

  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;}
  @media (max-width:900px){.grid{grid-template-columns:1fr;}}

  .card{
    background:rgba(15,23,42,.9);
    border-radius:16px;
    border:1px solid rgba(148,163,184,.4);
    padding:16px;
  }

  .routes{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
  .route-pill{
    flex:1 1 0;
    min-width:120px;
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,.6);
    cursor:pointer;
    background:rgba(15,23,42,.8);
  }
  .route-pill.active{
    border-color:#4f46e5;
    box-shadow:0 0 0 1px rgba(79,70,229,.6);
  }
  .route-pill h3{margin:0 0 4px;font-size:14px;}
  .route-pill p{margin:0;font-size:12px;color:#9ca3af;}

  .scores-table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
    font-size:12px;
  }
  .scores-table th,.scores-table td{
    border:1px solid rgba(148,163,184,.5);
    padding:4px 6px;
    text-align:center;
  }

  .plan-list{font-size:13px;margin-top:6px;}
  .plan-list li{margin-bottom:4px;}

  .chat-box{display:flex;flex-direction:column;gap:8px;}
  .chat-log{
    height:260px;
    overflow:auto;
    background:rgba(15,23,42,.8);
    border-radius:10px;
    padding:10px;
    border:1px solid rgba(148,163,184,.4);
    font-size:13px;
  }
  .chat-msg-user{color:#e5e7eb;margin-bottom:6px;}
  .chat-msg-ai{color:#a5b4fc;margin-bottom:10px;}

  .chat-input-row{display:flex;gap:8px;margin-top:4px;}
  .chat-input-row input{
    flex:1;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    outline:none;
  }
  .chat-input-row button{
    padding:8px 14px;
    border-radius:999px;
    border:0;
    background:linear-gradient(135deg,#4f46e5,#6366f1);
    color:#0b1120;
    font-weight:600;
    cursor:pointer;
  }

  .followups{font-size:12px;color:#9ca3af;margin-top:6px;}
  .followups span{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    margin:2px;
    cursor:pointer;
  }

  .ctx{font-size:11px;color:#9ca3af;margin-top:6px;}
</style>
</head>
<body>
<div class="wrap">
  <h1>${T.title}</h1>

  <div class="grid">
    <!-- å·¦ä¾§ï¼šè·¯çº¿ + è¯„åˆ† + è®¡åˆ’ -->
    <div class="card">
      <h2>${T.routes}</h2>
      <div class="routes" id="routes"></div>

      <h2>${T.scores}</h2>
      <table class="scores-table">
        <thead>
          <tr>
            <th>Route</th>
            <th>Risk</th>
            <th>Reward</th>
            <th>Time</th>
            <th>Mental</th>
          </tr>
        </thead>
        <tbody id="scoresBody"></tbody>
      </table>

      <h2>${T.plan}</h2>
      <ul class="plan-list" id="planList"></ul>

      <div class="ctx">
        <strong>${T.ctx}:</strong><br/>
        ${context.background}<br/>
        ${context.timeline}<br/>
        ${context.target}
      </div>
    </div>

    <!-- å³ä¾§ï¼šå¯¹è¯ -->
    <div class="card">
      <h2>${T.chat}</h2>
      <div class="chat-box">
        <div class="chat-log" id="chatLog"></div>
        <div class="followups" id="followupsBox"></div>

        <div class="chat-input-row">
          <input id="chatInput" placeholder="${T.placeholder}" />
          <button id="chatSend">${T.ask}</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const routes = ${JSON.stringify(routes || [])};
  const followups = ${JSON.stringify(followups || [])};
  const plan30d = ${JSON.stringify(plan30d || [])};
  const baseText = ${JSON.stringify(text || "")};
  const ctx = ${JSON.stringify(context)};

  const routesEl = document.getElementById("routes");
  const scoresBody = document.getElementById("scoresBody");
  const planList = document.getElementById("planList");
  const chatLog = document.getElementById("chatLog");
  const followupsBox = document.getElementById("followupsBox");
  const chatInput = document.getElementById("chatInput");
  const chatSend = document.getElementById("chatSend");

  /* -------------------------
     æ¸²æŸ“åˆå§‹æ–‡æœ¬
  -------------------------- */
  function appendAI(msg){
    const div = document.createElement("div");
    div.className = "chat-msg-ai";
    div.textContent = msg;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }
  function appendUser(msg){
    const div = document.createElement("div");
    div.className = "chat-msg-user";
    div.textContent = "You: " + msg;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  appendAI(baseText);

  /* -------------------------
     æ¸²æŸ“è·¯çº¿å¡ç‰‡
  -------------------------- */
  function renderRoutes(){
    routesEl.innerHTML = "";
    scoresBody.innerHTML = "";

    routes.forEach((r, idx)=>{
      const div = document.createElement("div");
      div.className = "route-pill" + (idx===0 ? " active" : "");
      div.innerHTML = `
        <h3>${r.id} Â· ${r.title}</h3>
        <p>${r.summary}</p>
      `;
      div.onclick = ()=>{
        document.querySelectorAll(".route-pill").forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
        appendAI("[" + r.id + "] " + r.summary);
      };
      routesEl.appendChild(div);

      const s = r.score || {};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${s.risk ?? "-"}</td>
        <td>${s.reward ?? "-"}</td>
        <td>${s.timeCost ?? "-"}</td>
        <td>${s.mentalCost ?? "-"}</td>
      `;
      scoresBody.appendChild(tr);
    });
  }

  /* -------------------------
     æ¸²æŸ“ 30 å¤©è®¡åˆ’
  -------------------------- */
  function renderPlan(){
    planList.innerHTML = "";
    plan30d.forEach(p=>{
      const li = document.createElement("li");
      li.textContent = p;
      planList.appendChild(li);
    });
  }

  /* -------------------------
     æ¸²æŸ“ followups
  -------------------------- */
  function renderFollowups(){
    followupsBox.innerHTML = "";
    if(!followups.length) return;

    followups.forEach(q=>{
      const span = document.createElement("span");
      span.textContent = q;
      span.onclick = ()=>{
        chatInput.value = q;
        chatInput.focus();
      };
      followupsBox.appendChild(span);
    });
  }

  renderRoutes();
  renderPlan();
  renderFollowups();

  /* -------------------------
     å‘é€è¿½é—®ï¼ˆchat æ¨¡å¼ï¼‰
  -------------------------- */
  async function sendChat(){
    const q = chatInput.value.trim();
    if(!q) return;

    appendUser(q);
    chatInput.value = "";
    appendAI("Thinking...");

    try{
      const res = await fetch("${API_BASE}/api/generate", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          background: ctx.background,
          timeline: ctx.timeline,
          target: ctx.target,
          resources: ctx.resources,
          mode:"chat",
          language: ctx.language,
          question: q,
          lastResult: baseText
        })
      });

      const data = await res.json();
      if(!data.ok){
        appendAI("Error: " + data.error);
        return;
      }

      appendAI(data.text);
    }catch(e){
      appendAI("Error: " + e);
    }
  }

  chatSend.onclick = sendChat;
  chatInput.addEventListener("keydown", e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      sendChat();
    }
  });
</script>

</body>
</html>
`;

  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ----------------------------------------------------
   å¼€å§‹æ¨¡æ‹Ÿï¼ˆä¸»çª—å£ï¼‰
----------------------------------------------------- */
$("btnRun").onclick = async ()=>{
  const background = $("background").value.trim();
  const timeline = $("timeline").value.trim();
  const target = $("target").value.trim();
  const resources = $("resources").value.trim();
  const mode = $("mode").value;
  const language = $("language").value;

  if(background.length + timeline.length < 60){
    hintShortEl.style.display = "block";
  } else {
    hintShortEl.style.display = "none";
  }

  if(!background || !timeline || !target){
    outEl.textContent = "è¯·å¡«å†™å®Œæ•´ä¿¡æ¯";
    return;
  }

  setStatus("ç”Ÿæˆä¸­...");
  setProgress(10);
  outEl.textContent = "â³ æ­£åœ¨ç”Ÿæˆï¼Œè¯·ç¨å€™â€¦";

  try{
    let fake = 10;
    const timer = setInterval(()=>{
      fake = Math.min(fake+5, 85);
      setProgress(fake);
    }, 800);

    const data = await postJSON(API_BASE + "/api/generate", {
      background, timeline, target, resources, mode, language
    });

    clearInterval(timer);
    setProgress(100);

    if(!data.ok){
      outEl.textContent = JSON.stringify(data, null, 2);
      return;
    }

    outEl.textContent = data.text;
    setStatus("å®Œæˆ");
    setTimeout(()=>setProgress(0),1000);

    /* æ‰“å¼€æ–°çª—å£ */
    openResultWindow({
      text: data.text,
      routes: data.routes,
      followups: data.followups,
      plan30d: data.plan30d,
      context:{ background, timeline, target, resources, language }
    });

  }catch(e){
    outEl.textContent = "é”™è¯¯ï¼š\n" + e;
    setStatus("å¤±è´¥");
    setProgress(0);
  }
};
</script>

</body>
</html>
