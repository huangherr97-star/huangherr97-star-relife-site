<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RE:LIFE | Result</title>

    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div id="result-container" class="result-container"></div>
<canvas id="radarChart" width="400" height="400"></canvas>

<script>
const LANG = {
    zh: {
        backHome: "返回首页",
        routeA: "路线 A",
        routeB: "路线 B",
        routeC: "路线 C",
        singleRoute: "单路线",
        chatMode: "对话模式",
        summary: "总结",
        scoreTitle: "自动评分雷达图",
        scoreLabels: ["整体满意度", "稳定性", "成长性", "自由度", "关系质量"]
    },
    en: {
        backHome: "Back to Home",
        routeA: "Route A",
        routeB: "Route B",
        routeC: "Route C",
        singleRoute: "Single Route",
        chatMode: "Chat Mode",
        summary: "Summary",
        scoreTitle: "Auto Score Radar Chart",
        scoreLabels: ["Satisfaction", "Stability", "Growth", "Freedom", "Relationships"]
    }
};

function getLang() {
    return localStorage.getItem("lang") || "zh";
}

function loadResultPage() {
    const lang = getLang();
    const dict = LANG[lang];

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    const data = JSON.parse(localStorage.getItem(id) || "{}");

    if (!data || !data.mode) {
        document.getElementById("result-container").innerText =
            lang === "zh" ? "未找到结果。" : "No result found.";
        return;
    }

    renderResult(data, dict);
    renderRadarChart(data, dict);
}

function renderResult(data, dict) {
    const container = document.getElementById("result-container");
    container.innerHTML = "";

    if (data.mode === "abc") {
        container.appendChild(createRouteCard(dict.routeA, data.routes.A));
        container.appendChild(createRouteCard(dict.routeB, data.routes.B));
        container.appendChild(createRouteCard(dict.routeC, data.routes.C));
    }

    if (data.mode === "single") {
        container.appendChild(createRouteCard(dict.singleRoute, data.routes.single));
    }

    if (data.mode === "chat") {
        const chatBox = document.createElement("div");
        chatBox.className = "chat-box";

        data.chat.forEach(msg => {
            const bubble = document.createElement("div");
            bubble.className = msg.role === "user" ? "bubble user" : "bubble ai";
            bubble.innerText = msg.content;
            chatBox.appendChild(bubble);
        });

        container.appendChild(chatBox);
    }

    container.appendChild(createRouteCard(dict.summary, data.summary));
}

function createRouteCard(title, text) {
    const card = document.createElement("div");
    card.className = "output-card";

    const header = document.createElement("div");
    header.className = "output-header";

    const h = document.createElement("div");
    h.className = "tag";
    h.innerText = title;

    header.appendChild(h);

    const body = document.createElement("div");
    body.innerText = text;

    card.appendChild(header);
    card.appendChild(body);

    return card;
}

function renderRadarChart(data, dict) {
    const ctx = document.getElementById("radarChart").getContext("2d");

    const scores = data.scores;

    new Chart(ctx, {
        type: "radar",
        data: {
            labels: dict.scoreLabels,
            datasets: [{
                label: dict.scoreTitle,
                data: [
                    scores.satisfaction,
                    scores.stability,
                    scores.growth,
                    scores.freedom,
                    scores.relationship
                ],
                fill: true,
                backgroundColor: "rgba(56, 189, 248, 0.2)",
                borderColor: "#38bdf8",
                pointBackgroundColor: "#38bdf8"
            }]
        },
        options: {
            scales: {
                r: {
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: { stepSize: 2, color: "#94a3b8" },
                    grid: { color: "rgba(148,163,184,0.3)" },
                    angleLines: { color: "rgba(148,163,184,0.3)" },
                    pointLabels: { color: "#e2e8f0" }
                }
            },
            plugins: { legend: { display: false } }
        }
    });
}

loadResultPage();
</script>

</body>
</html>
