<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RE:LIFE | Loading</title>

    <link rel="stylesheet" href="style.css" />
</head>

<body>

<div class="loading-page">
    <div class="loading-spinner"></div>
    <div id="loading-text" class="loading-text">Loading…</div>
</div>

<script>
/* -------------------------------
   多语言文案
-------------------------------- */
const LANG = {
    zh: { loading: "正在回环你的时间线，请稍候…" },
    en: { loading: "Rewinding your timeline…" }
};

function getLang() {
    return localStorage.getItem("lang") || "zh";
}

/* -------------------------------
   调用 API → 跳转 result.html
-------------------------------- */
async function runSimulation() {
    const lang = getLang();
    document.getElementById("loading-text").innerText = LANG[lang].loading;

    const payload = JSON.parse(localStorage.getItem("pendingPayload") || "{}");

    try {
        /* 
           ❗关键修复：
           强制访问 Vercel 的 API 域名
           避免 GitHub Pages 返回 405
        */
        const res = await fetch("https://www.resetlife.blog/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        /* ---- 安全解析 JSON（永不报 Unexpected token） ---- */
        const raw = await res.text();
        let data;

        try {
            data = JSON.parse(raw);
        } catch (err) {
            alert(
                lang === "zh"
                    ? "服务器返回了非 JSON 内容：\n" + raw
                    : "Server returned non‑JSON response:\n" + raw
            );
            return;
        }

        /* ---- 保存结果并跳转 ---- */
        const id = "run_" + Date.now();
        localStorage.setItem(id, JSON.stringify(data));

        window.location.href = "result.html?id=" + id;

    } catch (e) {
        alert("Error: " + e.message);
    }
}

/* 自动执行 */
runSimulation();
</script>

</body>
</html>
